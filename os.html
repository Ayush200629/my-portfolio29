<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebOS - Desktop Environment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            overflow: hidden;
            background: #000;
        }

        /* Power-on overlay */
        #poweron-overlay {
            position: fixed;
            z-index: 99999;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            transition: opacity 1s;
            opacity: 1;
        }

        /* BIOS Screen */
        .bios-screen {
            width: 100%;
            height: 100%;
            background: #000080;
            color: #ffffff;
            padding: 20px;
            font-size: 14px;
            line-height: 1.4;
            display: none;
            overflow-y: auto;
        }

        .bios-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ffffff;
            padding-bottom: 10px;
        }

        .bios-info {
            margin-bottom: 15px;
        }

        .bios-loading {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            border: 1px solid #ffffff;
            background: #000080;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00aa00);
            width: 0%;
            transition: width 0.3s ease;
        }

        .boot-sequence {
            background: #000;
            color: #00ff00;
            padding: 20px;
            font-size: 12px;
            line-height: 1.6;
            width: 100%;
            height: 100%;
            display: none;
            overflow-y: auto;
        }

        .boot-line {
            margin: 2px 0;
            opacity: 0;
            animation: fadeInLine 0.5s ease-in-out forwards;
        }

        .boot-line.ok {
            color: #00ff00;
        }

        .boot-line.loading {
            color: #ffff00;
        }

        .boot-line.error {
            color: #ff0000;
        }

        .boot-line.info {
            color: #00aaff;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        .welcome-screen {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #ffffff;
            padding: 40px;
            text-align: center;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .welcome-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            animation: slideInFromTop 1s ease-out;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.5s forwards;
        }

        .system-specs {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 1s forwards;
        }

        .enter-button {
            background: linear-gradient(45deg, #00ff88, #00cc66);
            color: #000;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 1s ease-out 1.5s forwards;
        }

        .enter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        /* Animations */
        @keyframes fadeInLine {
            0% { opacity: 0; transform: translateX(-10px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        @keyframes slideInFromTop {
            0% { transform: translateY(-50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInUp {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px #00ff00; }
            50% { text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00; }
        }

        .blinking-cursor::after {
            content: '_';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Power button effect */
        .power-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, #333, #000);
            border: 3px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #ff0000;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .power-button.active {
            color: #00ff00;
            box-shadow: 0 0 20px #00ff00;
            border-color: #00ff00;
        }

        .initial-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #666;
        }

        .initial-text {
            margin-top: 20px;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            /* Windows 11 wallpaper style */
            background: radial-gradient(ellipse at 60% 40%, #b4c6f8 0%, #7f9cf5 40%, #a5b4fc 100%),
                        linear-gradient(120deg, #e0e7ff 0%, #f0f4ff 100%);
            background-size: cover;
            background-position: center;
        }

        .desktop {
            width: 100vw;
            height: 100vh;
            position: relative;
            /* Subtle glass blur for desktop */
            background-image: var(--wallpaper, radial-gradient(ellipse at 60% 40%, #b4c6f8 0%, #7f9cf5 40%, #a5b4fc 100%));
            background-size: cover;
            background-position: center;
            backdrop-filter: blur(2.5px) saturate(1.1);
        }

        .taskbar {
            /* Windows 11 glassmorphism and layout */
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 700px; /* Fixed width for centered look */
            height: 56px;
            background: rgba(40, 40, 60, 0.7);
            backdrop-filter: blur(18px) saturate(1.5);
            border-radius: 18px 18px 0 0;
            box-shadow: 0 4px 32px 0 rgba(0,0,0,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 24px;
            z-index: 1000;
        }
        /* Center app icons */
        .app-icons {
            display: flex;
            gap: 18px;
            justify-content: center;
            flex: 1;
        }
        /* Start button Windows 11 style */
        .start-button {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255,255,255,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 18px;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.08);
        }
        .start-button:hover {
            background: rgba(255,255,255,0.28);
        }
        .start-icon {
            width: 26px;
            height: 26px;
            display: block;
        }
        /* Start menu (hidden by default) */
        .start-menu {
            position: fixed;
            left: 50%;
            bottom: 70px;
            transform: translateX(-50%);
            width: 340px;
            background: rgba(255,255,255,0.92);
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18);
            padding: 24px 20px 16px 20px;
            display: none;
            z-index: 2000;
        }
        .start-menu.active {
            display: block;
        }
        .start-menu h2 {
            font-size: 20px;
            margin-bottom: 12px;
            color: #222;
        }
        .start-menu .start-apps {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .start-menu .start-app {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.04);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .start-menu .start-app:hover {
            background: rgba(76,175,80,0.12);
        }
        .start-menu .start-app-icon {
            font-size: 24px;
        }
        .start-menu .start-app-label {
            font-size: 11px;
            margin-top: 4px;
            color: #333;
        }
        /* Clock stays at right */
        .clock {
            color: white;
            font-size: 15px;
            font-weight: 500;
            margin-left: auto;
            margin-right: 8px;
        }

        .app-icon {
            /* Windows 11 style: compact, dark glassy, visible */
            width: 28px;
            height: 28px;
            background: rgba(40,40,60,0.32);
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e3e6f3;
            cursor: pointer;
            transition: background 0.18s, transform 0.18s;
            font-size: 16px;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.10);
        }
        .app-icon:hover {
            background: rgba(40,40,60,0.48);
            transform: scale(1.10);
            color: #90b4fa;
        }

        .window {
            /* Windows 11 style: rounded corners, glass, shadow, animation */
            position: absolute;
            background: rgba(255,255,255,0.82); /* glassmorphism */
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18), 0 1.5px 6px 0 rgba(0,0,0,0.08);
            min-width: 300px;
            min-height: 200px;
            display: none;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(.4,1.4,.6,1);
            backdrop-filter: blur(18px) saturate(1.2);
            border: 1.5px solid rgba(180,180,220,0.13);
        }
        .window.active {
            z-index: 100;
        }
        /* Window open animation */
        .window-opening {
            animation: windowOpen 0.32s cubic-bezier(.4,1.4,.6,1);
        }
        @keyframes windowOpen {
            from {
                transform: scale(0.92) translateY(40px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        /* Modern window header */
        .window-header {
            background: linear-gradient(90deg, #f3f6fd 60%, #e0e7ef 100%);
            color: #222;
            padding: 14px 22px 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            border-bottom: 1px solid rgba(180,180,220,0.13);
        }
        .window-title {
            font-weight: 600;
            font-size: 15px;
            letter-spacing: 0.01em;
        }
        .window-controls {
            display: flex;
            gap: 10px;
        }
        .window-control {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            border: none;
            transition: background 0.18s;
        }
        .minimize { background: #ffbd2e; }
        .maximize { background: #28ca42; }
        .close { background: #ff5f56; }
        .window-control:hover {
            opacity: 0.8;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.08);
        }

        .window-content {
            padding: 20px;
            height: calc(100% - 50px);
            overflow: auto;
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            padding: 8px 0;
            font-size: 14px;
            color: #333;
        }

        .context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .context-menu li {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu li:hover {
            background: #4CAF50;
            color: white;
        }

        /* Notes App Styles */
        .notes-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .notes-header {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn:hover {
            background: #45a049;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
        }

        .note {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .note:hover {
            background: #f0f0f0;
        }

        .note-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .note-preview {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-editor {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .note-editor input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .note-editor textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: none;
        }

        /* Music Player Styles */
        .music-player {
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .album-art {
            width: 150px;
            height: 150px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 8px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
        }

        .track-info {
            margin-bottom: 20px;
        }

        .track-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .track-artist {
            color: #666;
        }

        .player-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .control-btn:hover {
            background: #45a049;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Calendar Styles */
        .calendar-container {
            height: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #f0f0f0;
        }

        .calendar-day.today {
            background: #4CAF50;
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        /* Terminal Styles */
        .terminal {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            height: 100%;
            padding: 10px;
            overflow-y: auto;
        }

        .terminal-line {
            margin-bottom: 5px;
        }

        .terminal-prompt {
            color: #00ff00;
        }

        .terminal-input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: inherit;
            outline: none;
            width: 100%;
        }

        /* Settings Styles */
        .settings-container {
            height: 100%;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .wallpaper-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .wallpaper-option {
            width: 100%;
            height: 60px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }

        .wallpaper-option.selected {
            border-color: #4CAF50;
        }

        .desktop-icons {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        /* Windows 11-style desktop icon */
        .desktop-icon {
            position: absolute;
            width: 64px;
            height: 64px;
            background: rgba(255,255,255,0.12);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #222;
            cursor: pointer;
            transition: top 0.3s cubic-bezier(.4,1.4,.6,1), left 0.3s cubic-bezier(.4,1.4,.6,1), transform 0.18s, background 0.18s;
            backdrop-filter: blur(6px) saturate(1.1);
            padding: 4px;
            box-sizing: border-box;
            text-align: center;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
        }
        .desktop-icon:hover {
            background: rgba(255,255,255,0.28);
            transform: scale(1.08);
            box-shadow: 0 4px 16px 0 rgba(0,0,0,0.10);
        }
        .desktop-icon-text {
            font-size: 10px;
            margin-top: 4px;
            text-align: center;
            color: #222;
            font-weight: 500;
            text-shadow: 0 2px 8px rgba(255,255,255,0.7), 0 1px 2px rgba(0,0,0,0.08);
            letter-spacing: 0.01em;
        }

        /* Calculator Styles */
        .calculator-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .calculator-display {
            background: #222;
            color: white;
            font-size: 32px;
            text-align: right;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            flex: 1;
        }
        .calc-btn {
            padding: 15px;
            font-size: 18px;
            border-radius: 4px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .calc-btn:hover {
            background: #ddd;
        }
        .calc-btn.wide {
            grid-column: span 2;
        }
        .calc-btn.operator {
            background: #ff9500;
            color: white;
        }
        .calc-btn.operator:hover {
            background: #e08400;
        }

        /* File Explorer Styles */
        .file-explorer {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: rgba(255,255,255,0.82); /* glassmorphism */
            color: #1e1e1e;
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(37,99,235,0.10), 0 1.5px 6px 0 rgba(0,0,0,0.08);
            backdrop-filter: blur(18px) saturate(1.2);
            border: 1.5px solid rgba(180,180,220,0.13);
        }
        .fe-toolbar {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background: rgba(245,247,255,0.92);
            border-bottom: 1.5px solid rgba(180,180,220,0.13);
            border-radius: 18px 18px 0 0;
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.04);
            gap: 8px;
        }
        .fe-toolbar button {
            width: 34px;
            height: 34px;
            border: none;
            background: rgba(40,40,60,0.10);
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.18s, color 0.18s;
            color: #2563eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fe-toolbar button:hover:not(:disabled) {
            background: #e1eaff;
            color: #1746a2;
        }
        .fe-toolbar button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        #fe-address-bar {
            flex: 1;
            margin: 0 8px;
            padding: 7px 14px;
            border: 1.5px solid #c7d2fe;
            border-radius: 10px;
            font-family: 'Segoe UI', sans-serif;
            background: rgba(255,255,255,0.92);
            font-size: 15px;
            color: #222;
            box-shadow: 0 1px 4px 0 rgba(37,99,235,0.04);
        }
        .fe-main-view {
            flex: 1;
            padding: 18px 18px 10px 18px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 22px;
            align-content: flex-start;
            overflow-y: auto;
            background: none;
        }
        .fe-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            padding: 16px 8px 10px 8px;
            border-radius: 12px;
            border: 1.5px solid transparent;
            background: rgba(255,255,255,0.18);
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.04);
            transition: background 0.18s, border 0.18s, box-shadow 0.18s, transform 0.18s;
            min-width: 80px;
        }
        .fe-item:hover {
            background: rgba(76,175,255,0.13);
            border-color: #b4c6f8;
            box-shadow: 0 4px 16px 0 rgba(37,99,235,0.10);
            transform: scale(1.04);
        }
        .fe-item .fe-icon {
            font-size: 38px;
            margin-bottom: 7px;
            filter: drop-shadow(0 2px 8px rgba(37,99,235,0.10));
        }
        .fe-item .fe-name {
            font-size: 13px;
            margin-top: 2px;
            word-break: break-word;
            color: #1746a2;
            font-weight: 500;
            text-shadow: 0 2px 8px rgba(255,255,255,0.7), 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Browser Styles */
        .browser-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #fff;
        }
        .browser-toolbar {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f1f1f1;
            border-bottom: 1px solid #ddd;
        }
        #browser-address-bar {
            flex: 1;
            margin: 0 8px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 15px;
            font-family: 'Segoe UI', sans-serif;
            background: white;
            outline: none;
        }
        #browser-address-bar:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        .browser-content {
            flex: 1;
            border: none;
            background: white;
        }

        /* --- Windows 11 Snap Layouts --- */
        .snap-preview {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            border-radius: 18px;
            background: rgba(76,175,255,0.13);
            border: 2.5px solid #2563eb;
            box-shadow: 0 4px 32px 0 rgba(37,99,235,0.08);
            display: none;
        }

        /* --- Windows 11 Desktop Widgets --- */
        .widgets-panel {
            position: fixed;
            right: 32px;
            top: 48px;
            width: 290px;
            background: rgba(255,255,255,0.92);
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(37,99,235,0.13), 0 1.5px 6px 0 rgba(0,0,0,0.10);
            border: 1.5px solid rgba(180,180,220,0.18);
            backdrop-filter: blur(18px) saturate(1.2);
            z-index: 1200;
            padding: 0 0 18px 0;
            display: flex;
            flex-direction: column;
            gap: 18px;
            min-height: 90px;
            min-width: 180px;
            transition: box-shadow 0.18s, right 0.18s, top 0.18s, transform 0.25s cubic-bezier(.4,1.4,.6,1);
            user-select: none;
        }
        .widgets-panel.hide {
            transform: translateX(110%);
            pointer-events: none;
            opacity: 0.2;
        }
        .widgets-hide-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            background: rgba(37,99,235,0.10);
            border: none;
            border-radius: 7px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #2563eb;
            z-index: 2;
            transition: background 0.18s;
        }
        .widgets-hide-btn:hover {
            background: #e1eaff;
        }
        .widgets-show-btn {
            position: fixed;
            right: 18px;
            top: 60px;
            width: 38px;
            height: 38px;
            background: rgba(255,255,255,0.92);
            border-radius: 50%;
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.10);
            border: 1.5px solid rgba(180,180,220,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 22px;
            color: #2563eb;
            z-index: 1201;
            transition: background 0.18s;
        }
        .widgets-show-btn:hover {
            background: #e1eaff;
        }
        .widgets-drag {
            width: 100%;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            border-radius: 18px 18px 0 0;
            background: linear-gradient(90deg, #e0e7ef 60%, #f3f6fd 100%);
            font-size: 15px;
            color: #2563eb;
            letter-spacing: 0.04em;
            font-weight: 600;
            margin-bottom: 8px;
            user-select: none;
            border-bottom: 1px solid #e0e7ef;
        }
        @media (max-width: 600px) {
            .widgets-panel {
                right: 0;
                top: 0;
                width: 98vw;
                min-width: 120px;
                border-radius: 0 0 18px 18px;
                padding: 0 0 8px 0;
            }
        }
        .widget {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: rgba(240,245,255,0.55);
            border-radius: 14px;
            padding: 14px 16px 12px 14px;
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.04);
            margin: 0 12px;
            margin-bottom: 2px;
            border: 1.2px solid rgba(180,180,220,0.10);
            transition: box-shadow 0.16s, background 0.16s;
        }
        .widget:hover {
            background: rgba(240,245,255,0.82);
            box-shadow: 0 4px 16px 0 rgba(37,99,235,0.10);
        }
        .widget-icon {
            font-size: 28px;
            margin-top: 2px;
        }
        .widget-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .widget-title {
            font-size: 13px;
            color: #2563eb;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .widget-value {
            font-size: 16px;
            color: #222;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .widget-date {
            font-size: 13px;
            color: #444;
            font-weight: 500;
        }

        /* Action Center Styles */
        .action-center-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: rgba(40,40,60,0.32);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e3e6f3;
            cursor: pointer;
            border: none;
            margin-left: 10px;
            font-size: 20px;
            transition: background 0.18s, color 0.18s;
        }
        .action-center-btn:hover {
            background: rgba(40,40,60,0.48);
            color: #90b4fa;
        }
        /* Action Center panel */
        .action-center {
            position: fixed;
            right: 32px;
            bottom: 70px;
            width: 340px;
            background: rgba(255,255,255,0.96);
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18);
            backdrop-filter: blur(18px) saturate(1.2);
            z-index: 3000;
            padding: 22px 22px 16px 22px;
            display: flex;
            flex-direction: column;
            gap: 18px;
                opacity: 0;
            pointer-events: none;
            transform: translateY(40px);
            transition: opacity 0.22s, transform 0.22s;
            }
        .action-center.active {
                opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
        .ac-quick-toggles {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .ac-toggle {
            flex: 1 1 30%;
            background: rgba(40,40,60,0.10);
            border-radius: 10px;
            padding: 10px 0 6px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #2563eb;
            font-size: 15px;
            font-weight: 600;
            border: none;
            margin-bottom: 6px;
            transition: background 0.18s, color 0.18s;
        }
        .ac-toggle.active {
            background: #2563eb;
            color: #fff;
        }
        .ac-toggle.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .ac-toggle-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }
        .ac-sliders {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .ac-slider-label {
            font-size: 13px;
            color: #2563eb;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .ac-slider {
            width: 100%;
        }
        .ac-notifications {
            margin-top: 10px;
            background: rgba(240,245,255,0.38);
            border-radius: 10px;
            padding: 10px 12px;
            min-height: 38px;
            font-size: 14px;
            color: #333;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.04);
            max-height: 120px;
            overflow-y: auto;
        }
        .ac-notification {
            background: rgba(255,255,255,0.92);
            border-radius: 7px;
            margin-bottom: 7px;
            padding: 7px 10px;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.04);
            font-size: 14px;
            color: #222;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeInNotif 0.3s;
        }
        @keyframes fadeInNotif {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dark-mode {
            background: #181c24 !important;
            color: #e3e6f3 !important;
        }
        .dark-mode .window,
        .dark-mode .action-center,
        .dark-mode .widgets-panel {
            background: rgba(30,34,44,0.97) !important;
            color: #e3e6f3 !important;
            border-color: rgba(80,80,120,0.18) !important;
        }
        .dark-mode .window-header {
            background: linear-gradient(90deg, #232a3a 60%, #232a3a 100%) !important;
            color: #e3e6f3 !important;
        }
        .dark-mode .start-menu {
            background: rgba(30,34,44,0.97) !important;
            color: #e3e6f3 !important;
        }
        .dark-mode .taskbar {
            background: rgba(24,28,36,0.92) !important;
        }
        .dark-mode .app-icon, .dark-mode .action-center-btn {
            background: rgba(60,60,80,0.32) !important;
            color: #e3e6f3 !important;
        }
        .dark-mode .app-icon:hover, .dark-mode .action-center-btn:hover {
            background: rgba(60,60,80,0.48) !important;
            color: #90b4fa !important;
        }
        .dark-mode .desktop {
            background-image: var(--wallpaper, radial-gradient(ellipse at 60% 40%, #232a3a 0%, #181c24 100%)) !important;
        }
        /* File Explorer Context Menu Styles */
        .fe-context-menu {
            position: fixed;
            z-index: 10010;
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(12px) saturate(1.1);
            border-radius: 10px;
            box-shadow: 0 4px 18px rgba(37,99,235,0.13);
            display: none;
            min-width: 160px;
            padding: 6px 0;
            font-size: 15px;
            color: #1746a2;
            border: 1.5px solid rgba(180,180,220,0.13);
        }
        .fe-context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .fe-context-menu li {
            padding: 10px 22px 10px 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border: none;
            background: none;
            transition: background 0.16s, color 0.16s;
        }
        .fe-context-menu li:hover {
            background: #e1eaff;
            color: #2563eb;
        }
        .fe-context-menu li.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        /* Paint App Styles */
        .paint-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .paint-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            padding-bottom: 6px;
        }
        .paint-toolbar label {
            font-size: 11px;
            color: #2563eb;
            font-weight: 500;
        }
        .paint-canvas {
            width: 100%;
            height: 100%;
            min-width: 180px;
            min-height: 100px;
            border: 1.5px solid #c7d2fe;
            border-radius: 7px;
            background: #fff;
            cursor: none;
            box-shadow: 0 1px 4px 0 rgba(37,99,235,0.04);
        }
        .paint-cursor {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            border-radius: 50%;
            border: 1.5px solid #2563eb44;
            box-sizing: border-box;
            mix-blend-mode: multiply;
            transition: background 0.1s, border 0.1s;
        }
        /* Gallery App Styles */
        .gallery-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
            gap: 8px;
            padding: 6px 0 0 0;
            overflow-y: auto;
            flex: 1;
        }
        .gallery-thumb {
            width: 48px;
            height: 48px;
            border-radius: 7px;
            object-fit: cover;
            box-shadow: 0 1px 4px 0 rgba(37,99,235,0.08);
            cursor: pointer;
            border: 1.5px solid #e0e7ef;
            transition: box-shadow 0.14s, border 0.14s;
        }
        .gallery-thumb:hover {
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.16);
            border-color: #2563eb;
        }
        .gallery-empty {
            color: #aaa;
            font-size: 12px;
            text-align: center;
            margin-top: 18px;
        }
        .gallery-preview {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(30,34,44,0.82);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .gallery-preview-img {
            max-width: 80vw;
            max-height: 80vh;
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18);
            background: #fff;
        }
        .gallery-preview-controls {
            position: absolute;
            top: 18px;
            right: 32px;
            display: flex;
            gap: 12px;
        }
        .gallery-preview-btn {
            background: rgba(255,255,255,0.92);
            border: none;
            border-radius: 7px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #2563eb;
            box-shadow: 0 2px 8px 0 rgba(37,99,235,0.10);
            transition: background 0.18s;
        }
        .gallery-preview-btn:hover {
            background: #e1eaff;
        }
        /* Task Manager App Styles */
        .taskman-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .taskman-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 8px;
        }
        .taskman-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 8px;
            border-radius: 7px;
            background: rgba(240,245,255,0.38);
            margin-bottom: 6px;
            box-shadow: 0 1px 4px 0 rgba(37,99,235,0.04);
            font-size: 13px;
        }
        .taskman-icon {
            font-size: 18px;
            width: 22px;
            text-align: center;
        }
        .taskman-title {
            flex: 1;
            font-weight: 500;
            color: #1746a2;
        }
        .taskman-state {
            font-size: 11px;
            color: #888;
            margin-right: 8px;
        }
        .taskman-btn {
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 2px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 2px;
            transition: background 0.16s;
        }
        .taskman-btn:hover {
            background: #1746a2;
        }
        /* Sticky Notes App Styles */
        .stickynotes-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .stickynotes-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 8px;
        }
        .stickynote-item {
            background: #fffbe7;
            border: 1.5px solid #ffe066;
            border-radius: 7px;
            margin-bottom: 7px;
            padding: 7px 8px;
            font-size: 13px;
            color: #444;
            box-shadow: 0 1px 4px 0 rgba(255,224,102,0.10);
            position: relative;
        }
        .stickynote-delete {
            position: absolute;
            top: 4px;
            right: 7px;
            background: none;
            border: none;
            color: #e57373;
            font-size: 15px;
            cursor: pointer;
        }
        .stickynotes-add {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        .stickynotes-add input, .stickynotes-add textarea {
            font-size: 13px;
            border-radius: 5px;
            border: 1px solid #ffe066;
            padding: 2px 6px;
        }
        .stickynotes-add textarea {
            resize: none;
        }
        .stickynotes-add button {
            background: #ffe066;
            color: #444;
            border: none;
            border-radius: 5px;
            padding: 2px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.16s;
        }
        .stickynotes-add button:hover {
            background: #ffd700;
        }
        /* Alarm/Timer App Styles */
        .alarm-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .alarm-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 8px;
        }
        .alarm-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 8px;
            border-radius: 7px;
            background: #e0f7fa;
            margin-bottom: 6px;
            box-shadow: 0 1px 4px 0 rgba(37,99,235,0.04);
            font-size: 13px;
            color: #00796b;
        }
        .alarm-btn {
            background: #4dd0e1;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 2px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 2px;
            transition: background 0.16s;
        }
        .alarm-btn:hover {
            background: #0097a7;
        }
        /* Markdown Editor App Styles */
        .mdeditor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .mdeditor-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 4px;
        }
        .mdeditor-editor {
            flex: 1;
            width: 100%;
            min-height: 40px;
            border: 1.5px solid #c7d2fe;
            border-radius: 7px;
            padding: 6px;
            font-size: 13px;
            font-family: 'Segoe UI', monospace;
            resize: none;
            margin-bottom: 4px;
        }
        .mdeditor-preview {
            flex: 1;
            width: 100%;
            min-height: 40px;
            border: 1.5px solid #e0e7ef;
            border-radius: 7px;
            padding: 6px;
            font-size: 13px;
            background: #f8fafc;
            overflow-y: auto;
        }
        /* Minesweeper App Styles */
        .minesweeper-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            align-items: center;
        }
        .minesweeper-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }
        .minesweeper-board {
            display: grid;
            gap: 3px;
            background: #e0e7ef;
            border-radius: 7px;
            padding: 4px;
            margin-bottom: 6px;
            max-height: 140px;
            overflow: auto;
        }
        .minesweeper-cell {
            width: 28px;
            height: 28px;
            background: #fff;
            border: 1px solid #c7d2fe;
            border-radius: 3px;
            font-size: 18px;
            text-align: center;
            line-height: 28px;
            cursor: pointer;
            user-select: none;
            transition: background 0.12s;
        }
        .minesweeper-cell.revealed {
            background: #e0e7ef;
            cursor: default;
        }
        .minesweeper-cell.mine {
            background: #ffeaea;
            color: #e57373;
        }
        .minesweeper-cell.flag {
            background: #fffbe7;
            color: #ffd700;
        }
        .minesweeper-status {
            font-size: 13px;
            margin-bottom: 4px;
        }
        /* Scientific Calculator App Styles */
        .scicalc-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .scicalc-display {
            background: #222;
            color: #fff;
            font-size: 20px;
            text-align: right;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .scicalc-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        .scicalc-btn {
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .scicalc-btn:hover {
            background: #ddd;
        }
        .scicalc-btn.op {
            background: #4caf50;
            color: #fff;
        }
        .scicalc-btn.op:hover {
            background: #388e3c;
        }
        .scicalc-history {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            min-height: 16px;
        }
        /* Tic-Tac-Toe App Styles */
        .ttt-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        .ttt-board {
            display: grid;
            grid-template-columns: repeat(3, 36px);
            grid-template-rows: repeat(3, 36px);
            gap: 4px;
            margin: 10px 0;
        }
        .ttt-cell {
            width: 36px;
            height: 36px;
            background: #fff;
            border: 2px solid #c7d2fe;
            border-radius: 6px;
            font-size: 22px;
            text-align: center;
            line-height: 36px;
            cursor: pointer;
            user-select: none;
            transition: background 0.14s;
        }
        .ttt-cell:hover {
            background: #e1eaff;
        }
        .ttt-status {
            font-size: 13px;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <!-- Initial Power Off Screen -->
    <div id="poweron-overlay">
        <div class="initial-screen">
            <div class="power-button" id="powerButton"></div>
            <div class="initial-text">Press power button to boot</div>
    </div>
    </div>

    <!-- BIOS Screen -->
    <div class="bios-screen" id="biosScreen">
        <div class="bios-header">
            <h2>AYUSH BIOS SETUP UTILITY</h2>
            <p>Version 2.1.0 - Portfolio Edition</p>
        </div>
        
        <div class="bios-info">
            <div><strong>System Information:</strong></div>
            <div>Processor: Intel Core i9-Portfolio @ 3.6GHz</div>
            <div>Memory: 32GB DDR4 Creative RAM</div>
            <div>Storage: 1TB NVMe Skills Drive</div>
            <div>Graphics: NVIDIA RTX Portfolio Pro</div>
        </div>

        <div class="bios-loading">
            <span>Memory Test:</span>
            <div class="progress-bar">
                <div class="progress-fill" id="memoryProgress"></div>
            </div>
            <span id="memoryPercent">0%</span>
        </div>

        <div class="bios-loading">
            <span>Skills Loading:</span>
            <div class="progress-bar">
                <div class="progress-fill" id="skillsProgress"></div>
            </div>
            <span id="skillsPercent">0%</span>
        </div>

        <div class="bios-loading">
            <span>Portfolio Init:</span>
            <div class="progress-bar">
                <div class="progress-fill" id="portfolioProgress"></div>
            </div>
            <span id="portfolioPercent">0%</span>
        </div>
    </div>

    <!-- Boot Sequence -->
    <div class="boot-sequence" id="bootSequence">
        <div class="boot-line">Starting Ayush Portfolio WebOS...</div>
        <div class="boot-line">[    0.000000] Initializing creative kernel...</div>
        <div class="boot-line ok">[    0.123456] CPU: Intel Core i9-Portfolio detected</div>
        <div class="boot-line ok">[    0.234567] Memory: 32GB Creative RAM initialized</div>
        <div class="boot-line loading">[    0.345678] Loading skill modules<span class="loading-dots"></span></div>
        <div class="boot-line ok">[    0.456789] JavaScript module loaded successfully</div>
        <div class="boot-line ok">[    0.567890] React framework initialized</div>
        <div class="boot-line ok">[    0.678901] Node.js runtime ready</div>
        <div class="boot-line ok">[    0.789012] Python interpreter loaded</div>
        <div class="boot-line ok">[    0.890123] Database systems online</div>
        <div class="boot-line info">[    1.001234] Mounting project repositories...</div>
        <div class="boot-line ok">[    1.112345] /projects/web-development mounted</div>
        <div class="boot-line ok">[    1.223456] /projects/mobile-apps mounted</div>
        <div class="boot-line ok">[    1.334567] /projects/full-stack mounted</div>
        <div class="boot-line loading">[    1.445678] Starting network services<span class="loading-dots"></span></div>
        <div class="boot-line ok">[    1.556789] Portfolio API server started</div>
        <div class="boot-line ok">[    1.667890] Contact form service initialized</div>
        <div class="boot-line ok">[    1.778901] Social media links configured</div>
        <div class="boot-line info">[    1.889012] Loading user interface components...</div>
        <div class="boot-line ok">[    2.000123] Navigation system loaded</div>
        <div class="boot-line ok">[    2.111234] Theme engine initialized</div>
        <div class="boot-line ok">[    2.222345] Animation framework ready</div>
        <div class="boot-line ok">[    2.333456] Responsive design modules loaded</div>
        <div class="boot-line loading">[    2.444567] Final system checks<span class="loading-dots"></span></div>
        <div class="boot-line ok">[    2.555678] All systems operational</div>
        <div class="boot-line ok">[    2.666789] Ayush Portfolio WebOS ready!</div>
        <div class="boot-line info">[    2.777890] Welcome to the portfolio experience</div>
        <div class="boot-line blinking-cursor">root@ayush-portfolio:~# </div>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-title"> Ayush Portfolio WebOS</div>
        <div class="welcome-subtitle">Professional Developer Portfolio System</div>
        
        <div class="system-specs">
            <h3>System Ready</h3>
            <p> All modules loaded successfully</p>
            <p> Projects database online</p>
            <p> Contact systems operational</p>
            <p> User interface initialized</p>
        </div>
        
        <button class="enter-button" onclick="enterPortfolio()">
            Enter Portfolio Experience
        </button>
    </div>

    <!-- Lock Screen Overlay (Windows 11 style) -->
    <div id="lockscreen-overlay" style="
        position:fixed;z-index:99998;top:0;left:0;width:100vw;height:100vh;
        background: linear-gradient(120deg, #4f8efc 0%, #a5b4fc 100%);
        display:none;flex-direction:column;align-items:center;justify-content:center;
        color:#fff;font-family:'Segoe UI',sans-serif;transition:transform 0.7s cubic-bezier(.4,1.4,.6,1), opacity 0.7s;opacity:1;
    ">
        <!-- Blurred scenic background -->
        <div id="lockscreen-bg" style="
            position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:0;
            background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1500&q=80') center/cover no-repeat;
            filter: blur(4px) brightness(0.7);
        "></div>
        <div style="position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;">
            <!-- Time and date -->
            <div id="lockscreen-time" style="font-size:3.5rem;font-weight:600;margin-bottom:0.5em;"></div>
            <div id="lockscreen-date" style="font-size:1.3rem;margin-bottom:2em;"></div>
            <!-- Slide up prompt -->
            <div style="font-size:1.2rem;opacity:0.8;">Slide up to unlock</div>
            <div id="lockscreen-arrow" style="margin-top:2em;font-size:2.5rem;animation:arrowUp 1.2s infinite alternate;"></div>
        </div>
    </div>

    <div class="desktop" id="desktop" style="display:none;">
        <!-- Snap preview overlay (hidden by default) -->
        <div id="snap-preview" class="snap-preview"></div>
        <!-- Desktop Icons -->
        <div class="desktop-icons">
            <!-- Notes App Icon -->
            <div class="desktop-icon" data-app="notes">
                <div class="icon-container notes-icon"><span></span></div>
                <div class="desktop-icon-text">Notes</div>
            </div>
            <!-- Music App Icon -->
            <div class="desktop-icon" data-app="music">
                <div class="icon-container music-icon"><span></span></div>
                <div class="desktop-icon-text">Music</div>
            </div>
            <!-- Calendar App Icon -->
            <div class="desktop-icon" data-app="calendar">
                <div class="icon-container calendar-icon"><span></span></div>
                <div class="desktop-icon-text">Calendar</div>
            </div>
            <!-- Terminal App Icon -->
            <div class="desktop-icon" data-app="terminal">
                <div class="icon-container terminal-icon"><span></span></div>
                <div class="desktop-icon-text">Terminal</div>
            </div>
            <!-- Settings App Icon -->
            <div class="desktop-icon" data-app="settings">
                <div class="icon-container settings-icon"><span></span></div>
                <div class="desktop-icon-text">Settings</div>
            </div>
            <!-- Calculator App Icon -->
            <div class="desktop-icon" data-app="calculator">
                <div class="icon-container calculator-icon"><span></span></div>
                <div class="desktop-icon-text">Calculator</div>
            </div>
            <!-- Files App Icon -->
            <div class="desktop-icon" data-app="files">
                <div class="icon-container files-icon"><span></span></div>
                <div class="desktop-icon-text">Files</div>
            </div>
            <!-- Browser App Icon -->
            <div class="desktop-icon" data-app="browser">
                <div class="icon-container browser-icon"><span></span></div>
                <div class="desktop-icon-text">Browser</div>
            </div>
            <!-- Paint App Icon -->
            <div class="desktop-icon" data-app="paint">
                <div class="icon-container paint-icon"><span></span></div>
                <div class="desktop-icon-text">Paint</div>
            </div>
            <!-- Gallery App Icon -->
            <div class="desktop-icon" data-app="gallery">
                <div class="icon-container gallery-icon"><span></span></div>
                <div class="desktop-icon-text">Gallery</div>
            </div>
            <!-- Sticky Notes App Icon -->
            <div class="desktop-icon" data-app="stickynotes">
                <div class="icon-container stickynotes-icon"><span></span></div>
                <div class="desktop-icon-text">Sticky</div>
            </div>
            <!-- Alarm App Icon -->
            <div class="desktop-icon" data-app="alarm">
                <div class="icon-container alarm-icon"><span></span></div>
                <div class="desktop-icon-text">Alarm</div>
            </div>
            <!-- Minesweeper App Icon -->
            <div class="desktop-icon" data-app="minesweeper">
                <div class="icon-container minesweeper-icon"><span></span></div>
                <div class="desktop-icon-text">Minesweeper</div>
            </div>
            <!-- Scientific Calculator App Icon -->
            <div class="desktop-icon" data-app="scicalc">
                <div class="icon-container scicalc-icon"><span></span></div>
                <div class="desktop-icon-text">SciCalc</div>
            </div>
            <!-- TicTacToe App Icon -->
            <div class="desktop-icon" data-app="tictactoe">
                <div class="icon-container tictactoe-icon"><span></span></div>
                <div class="desktop-icon-text">TicTacToe</div>
            </div>
            <!-- ProTrade App Icon (Demo Trading App) -->
            <div class="desktop-icon" data-app="protrade">
                <div class="icon-container protrade-icon"><span></span></div>
                <div class="desktop-icon-text">ProTrade</div>
            </div>
            <!-- Reciepy App Icon -->
            <div class="desktop-icon" data-app="reciepy">
                <div class="icon-container reciepy-icon"><span></span></div>
                <div class="desktop-icon-text">Reciepy</div>
            </div>
            <!-- Shoppy.com App Icon -->
            <div class="desktop-icon" data-app="shoppy">
                <div class="icon-container shoppy-icon"><span></span></div>
                <div class="desktop-icon-text">shoppy.com</div>
            </div>
            <!-- Maze Game App Icon -->
            <div class="desktop-icon" data-app="maze">
                <div class="icon-container maze-icon"><span></span></div>
                <div class="desktop-icon-text">Maze Game</div>
            </div>
        </div>

        <!-- Notes Window -->
        <div class="window" id="notes-window" style="width: 340px; height: 260px; top: 80px; left: 80px;">
            <div class="window-header">
                <span class="window-title">Notes</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content">
                <div class="notes-container">
                    <div class="notes-header">
                        <button class="btn" id="new-note-btn">New Note</button>
                        <button class="btn" id="save-note-btn" style="display: none;">Save</button>
                        <button class="btn" id="back-to-notes-btn" style="display: none;">Back</button>
                    </div>
                    <div class="notes-list" id="notes-list"></div>
                    <div class="note-editor" id="note-editor">
                        <input type="text" id="note-title-input" placeholder="Note title...">
                        <textarea id="note-content-input" placeholder="Write your note here..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Music Window -->
        <div class="window" id="music-window" style="width: 260px; height: 220px; top: 120px; left: 200px;">
            <div class="window-header">
                <span class="window-title">Music Player</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content">
                <div class="music-player">
                    <div class="album-art"></div>
                    <div class="track-info">
                        <div class="track-title" id="track-title">Awesome Song</div>
                        <div class="track-artist" id="track-artist">Unknown Artist</div>
                    </div>
                    <div class="player-controls">
                        <button class="control-btn" id="prev-btn"></button>
                        <button class="control-btn" id="play-btn"></button>
                        <button class="control-btn" id="next-btn"></button>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" id="progress"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Window -->
        <div class="window" id="calendar-window" style="width: 340px; height: 260px; top: 80px; left: 300px;">
            <div class="window-header">
                <span class="window-title">Calendar</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" id="prev-month"></button>
                        <h2 id="current-month">January 2025</h2>
                        <button class="calendar-nav" id="next-month"></button>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                </div>
            </div>
        </div>

        <!-- Terminal Window -->
        <div class="window" id="terminal-window" style="width: 380px; height: 220px; top: 150px; left: 150px;">
            <div class="window-header" style="background: linear-gradient(90deg, #333, #555);">
                <span class="window-title">Terminal</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 0;">
                <div class="terminal" id="terminal">
                    <div class="terminal-line">WebOS Terminal v1.0</div>
                    <div class="terminal-line">Type 'help' for available commands</div>
                    <div class="terminal-line new-prompt-line">
                        <span class="terminal-prompt"></span>
                        <input type="text" class="terminal-input" id="terminal-input">
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Window -->
        <div class="window" id="settings-window" style="width: 300px; height: 220px; top: 100px; left: 400px;">
            <div class="window-header">
                <span class="window-title">Settings</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content">
                <div class="settings-container">
                    <div class="settings-section">
                        <h3>Wallpaper</h3>
                        <div class="wallpaper-options">
                            <!-- Scenic Image Wallpapers (Unsplash) -->
                            <!-- Replace the URLs below with your favorite scenic images if desired -->
                            <div class="wallpaper-option" data-wallpaper="url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1500&q=80')" style="background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80');"></div>
                            <div class="wallpaper-option" data-wallpaper="url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=1500&q=80')" style="background-image: url('https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=400&q=80');"></div>
                            <div class="wallpaper-option" data-wallpaper="url('https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=1500&q=80')" style="background-image: url('https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?auto=format&fit=crop&w=400&q=80');"></div>
                            <div class="wallpaper-option" data-wallpaper="url('https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1500&q=80')" style="background-image: url('https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=400&q=80');"></div>
                            <div class="wallpaper-option" data-wallpaper="url('https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=1500&q=80')" style="background-image: url('https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=400&q=80');"></div>
                            <!-- Gradient Wallpapers (original options) -->
                            <div class="wallpaper-option" data-wallpaper="linear-gradient(135deg, #667eea 0%, #764ba2 100%)" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                            <div class="wallpaper-option" data-wallpaper="linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"></div>
                            <div class="wallpaper-option" data-wallpaper="linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"></div>
                            <div class="wallpaper-option" data-wallpaper="linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);"></div>
                            <div class="wallpaper-option" data-wallpaper="linear-gradient(135deg, #fa709a 0%, #fee140 100%)" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"></div>
                            <div class="wallpaper-option" data-wallpaper="linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Explorer Window -->
        <div class="window" id="files-window" style="width: 340px; height: 260px; top: 100px; left: 250px;">
            <div class="window-header">
                <span class="window-title">File Explorer</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 0;">
                <div class="file-explorer">
                    <div class="fe-toolbar">
                        <button id="fe-back-btn" disabled></button>
                        <button id="fe-forward-btn" disabled></button>
                        <button id="fe-up-btn"></button>
                        <input type="text" id="fe-address-bar" readonly>
                    </div>
                    <div class="fe-main-view" id="fe-main-view"></div>
                </div>
                <!-- File Explorer Context Menu -->
                <div class="fe-context-menu" id="fe-context-menu">
                    <ul>
                        <li id="fe-cm-open"> Open</li>
                        <li id="fe-cm-rename"> Rename</li>
                        <li id="fe-cm-delete"> Delete</li>
                        <li id="fe-cm-copy"> Copy</li>
                        <li id="fe-cm-cut"> Cut</li>
                        <li id="fe-cm-paste"> Paste</li>
                        <li id="fe-cm-properties"> Properties</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Browser Window -->
        <div class="window" id="browser-window" style="width: 420px; height: 320px; top: 50px; left: 150px;">
            <div class="window-header">
                <span class="window-title">Browser</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 0;">
                <div class="browser-container">
                    <div class="browser-toolbar">
                        <button id="browser-back-btn" class="fe-toolbar-button"></button>
                        <button id="browser-forward-btn" class="fe-toolbar-button"></button>
                        <button id="browser-refresh-btn" class="fe-toolbar-button"></button>
                        <button id="browser-home-btn" class="fe-toolbar-button"></button>
                        <input type="text" id="browser-address-bar" placeholder="Search Google or type a URL">
                    </div>
                    <iframe id="browser-content" class="browser-content" src="about:blank" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-presentation allow-same-origin allow-scripts"></iframe>
                </div>
            </div>
        </div>

        <!-- Calculator Window -->
        <div class="window" id="calculator-window" style="width: 180px; height: 220px; top: 150px; left: 450px;">
            <div class="window-header">
                <span class="window-title">Calculator</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content">
                <div class="calculator-container">
                    <div id="calc-display" class="calculator-display">0</div>
                    <div class="calculator-buttons">
                        <button class="calc-btn wide" data-value="clear">C</button>
                        <button class="calc-btn" data-value="backspace"></button>
                        <button class="calc-btn operator" data-value="/"></button>
                        
                        <button class="calc-btn" data-value="7">7</button>
                        <button class="calc-btn" data-value="8">8</button>
                        <button class="calc-btn" data-value="9">9</button>
                        <button class="calc-btn operator" data-value="*"></button>
                        
                        <button class="calc-btn" data-value="4">4</button>
                        <button class="calc-btn" data-value="5">5</button>
                        <button class="calc-btn" data-value="6">6</button>
                        <button class="calc-btn operator" data-value="-">-</button>
                        
                        <button class="calc-btn" data-value="1">1</button>
                        <button class="calc-btn" data-value="2">2</button>
                        <button class="calc-btn" data-value="3">3</button>
                        <button class="calc-btn operator" data-value="+">+</button>

                        <button class="calc-btn wide" data-value="0">0</button>
                        <button class="calc-btn" data-value=".">.</button>
                        <button class="calc-btn operator" data-value="=">=</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paint App Window -->
        <div class="window" id="paint-window" style="width: 900px; height: 700px; top: 80px; left: 80px; display:none;">
            <div class="window-header">
                <span class="window-title">Paint</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding:0;display:flex;flex-direction:column;height:100%;">
                <iframe id="paint-iframe"
                    src="painting.html"
                    style="width:100%;height:100%;border:none;display:block;border-radius:8px;box-shadow:0 2px 8px #0002;"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                    loading="lazy"
                ></iframe>
            </div>
        </div>

        <!-- Gallery App Window -->
        <div class="window" id="gallery-window" style="width: 260px; height: 220px; top: 220px; left: 220px; display:none;">
            <div class="window-header">
                <span class="window-title">Gallery</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 10px;">
                <div class="gallery-container">
                    <div class="gallery-grid" id="gallery-grid"></div>
                </div>
            </div>
        </div>
        <div id="gallery-preview" class="gallery-preview" style="display:none;">
            <div class="gallery-preview-controls">
                <button class="gallery-preview-btn" id="gallery-prev-btn" title="Previous"></button>
                <button class="gallery-preview-btn" id="gallery-next-btn" title="Next"></button>
                <button class="gallery-preview-btn" id="gallery-close-btn" title="Close"></button>
            </div>
            <img id="gallery-preview-img" class="gallery-preview-img" src="" alt="Preview">
        </div>

        <!-- Taskbar -->
        <div class="taskbar">
            <!-- Windows 11 Start Button -->
            <button class="start-button" id="start-button" title="Start">
                <!-- Windows 11 Start icon SVG -->
                <svg class="start-icon" viewBox="0 0 32 32"><rect x="3" y="3" width="12" height="12" rx="3" fill="#2563eb"/><rect x="17" y="3" width="12" height="12" rx="3" fill="#22d3ee"/><rect x="3" y="17" width="12" height="12" rx="3" fill="#22d3ee"/><rect x="17" y="17" width="12" height="12" rx="3" fill="#2563eb"/></svg>
            </button>
            <div class="app-icons">
                <div class="app-icon" data-app="notes"></div>
                <div class="app-icon" data-app="music"></div>
                <div class="app-icon" data-app="calendar"></div>
                <div class="app-icon" data-app="terminal"></div>
                <div class="app-icon" data-app="settings"></div>
                <div class="app-icon" data-app="calculator"></div>
                <div class="app-icon" data-app="files"></div>
                <div class="app-icon" data-app="browser"></div>
                <div class="app-icon" data-app="paint"></div>
                <div class="app-icon" data-app="gallery"></div>
              
            
               
            </div>
            <div class="clock" id="clock">12:00 PM</div>
            <!-- Action Center Button -->
            <button class="action-center-btn" id="action-center-btn" title="Action Center">
                <svg width="22" height="22" viewBox="0 0 22 22"><rect x="2" y="2" width="7" height="7" rx="2" fill="#2563eb"/><rect x="13" y="2" width="7" height="7" rx="2" fill="#22d3ee"/><rect x="2" y="13" width="7" height="7" rx="2" fill="#22d3ee"/><rect x="13" y="13" width="7" height="7" rx="2" fill="#2563eb"/></svg>
            </button>
        </div>
        <!-- Action Center Panel -->
        <div class="action-center" id="action-center">
            <div class="ac-quick-toggles">
                <button class="ac-toggle" id="ac-wifi"><span class="ac-toggle-icon"></span>Wi-Fi</button>
                <button class="ac-toggle" id="ac-bluetooth"><span class="ac-toggle-icon"></span>Bluetooth</button>
                <button class="ac-toggle" id="ac-night"><span class="ac-toggle-icon"></span>Night</button>
                <button class="ac-toggle" id="ac-dark"><span class="ac-toggle-icon"></span>Dark</button>
                <button class="ac-toggle" id="ac-airplane"><span class="ac-toggle-icon"></span>Airplane</button>
                <button class="ac-toggle" id="ac-dnd"><span class="ac-toggle-icon"></span>DND</button>
            </div>
            <div class="ac-sliders">
                <div>
                    <div class="ac-slider-label">Volume</div>
                    <input type="range" min="0" max="100" value="60" class="ac-slider" id="ac-volume">
                </div>
                <div>
                    <div class="ac-slider-label">Brightness</div>
                    <input type="range" min="0" max="100" value="80" class="ac-slider" id="ac-brightness">
                </div>
            </div>
            <div class="ac-notifications" id="ac-notifications">
                <div>No new notifications</div>
            </div>
        </div>

        <!-- Windows 11-style Desktop Widgets Panel -->
        <div class="widgets-panel" id="widgets-panel">
            <button class="widgets-hide-btn" id="widgets-hide-btn" title="Hide Widgets"></button>
            <div class="widgets-drag" id="widgets-drag"> <span style="font-size:18px; margin-right:7px;"></span> Widgets </div>
            <!-- Quick Notes Widget -->
            <div class="widget" id="quick-notes-widget">
                <div class="widget-icon"></div>
                <div class="widget-info">
                    <div class="widget-title">Quick Note</div>
                    <textarea id="quick-note-input" style="width: 100%; min-height: 32px; border-radius: 6px; border: 1px solid #c7d2fe; font-size: 13px; padding: 4px; resize: vertical;"></textarea>
                </div>
            </div>
            <!-- To-Do List Widget -->
            <div class="widget" id="todo-widget">
                <div class="widget-icon"></div>
                <div class="widget-info">
                    <div class="widget-title">To-Do List</div>
                    <ul id="todo-list" style="margin:0; padding-left:18px; font-size:13px;"></ul>
                    <input id="todo-input" type="text" placeholder="Add task..." style="width:90%; margin-top:4px; font-size:13px; border-radius:5px; border:1px solid #c7d2fe; padding:2px 6px;">
                </div>
            </div>
            <!-- Clock Widget -->
            <div class="widget" id="clock-widget">
                <div class="widget-icon"></div>
                <div class="widget-info">
                    <div class="widget-title">Clock</div>
                    <div class="widget-value" id="widget-clock-value">--:--</div>
                    <div class="widget-date" id="widget-clock-date">--</div>
                </div>
            </div>
            <!-- Weather Widget -->
            <div class="widget" id="weather-widget">
                <div class="widget-icon"></div>
                <div class="widget-info">
                    <div class="widget-title">Weather</div>
                    <div class="widget-value" id="weather-value">Loading...</div>
                </div>
            </div>
            <!-- Calendar Widget -->
            <div class="widget" id="calendar-widget">
                <div class="widget-icon"></div>
                <div class="widget-info">
                    <div class="widget-title">Today</div>
                    <div class="widget-date" id="calendar-date">--</div>
                </div>
            </div>
        </div>
        <button class="widgets-show-btn" id="widgets-show-btn" title="Show Widgets" style="display:none;"></button>

        <!-- Task Manager App Window -->
        <div class="window" id="taskman-window" style="width: 260px; height: 220px; top: 260px; left: 260px; display:none;">
            <div class="window-header">
                <span class="window-title">Task Manager</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 10px;">
                <div class="taskman-container">
                    <div class="taskman-list" id="taskman-list"></div>
                </div>
            </div>
        </div>
        <!-- Sticky Notes App Window -->
        <div class="window" id="stickynotes-window" style="width: 220px; height: 220px; top: 300px; left: 300px; display:none;">
            <div class="window-header">
                <span class="window-title">Sticky Notes</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 10px;">
                <div class="stickynotes-container">
                    <div class="stickynotes-add">
                        <input id="stickynote-title" type="text" placeholder="Title" maxlength="20" style="width:60px;">
                        <textarea id="stickynote-content" rows="1" placeholder="Note..." maxlength="60" style="width:80px;"></textarea>
                        <button id="stickynote-add">Add</button>
                    </div>
                    <div class="stickynotes-list" id="stickynotes-list"></div>
                </div>
            </div>
        </div>
        <!-- Alarm/Timer App Window -->
        <div class="window" id="alarm-window" style="width: 220px; height: 220px; top: 340px; left: 340px; display:none;">
            <div class="window-header">
                <span class="window-title">Alarm & Timer</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 10px;">
                <div class="alarm-container">
                    <div style="display:flex; gap:6px; margin-bottom:6px;">
                        <input id="alarm-time" type="time" style="width:70px;">
                        <input id="timer-mins" type="number" min="1" max="999" placeholder="min" style="width:38px;">
                        <button id="alarm-add" class="alarm-btn">Set</button>
                    </div>
                    <div class="alarm-list" id="alarm-list"></div>
                </div>
            </div>
        </div>
        <!-- Minesweeper App Window -->
        <div class="window" id="minesweeper-window" style="width: 220px; height: 220px; top: 420px; left: 420px; display:none;">
            <div class="window-header">
                <span class="window-title">Minesweeper</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 10px;">
                <div class="minesweeper-container">
                    <div class="minesweeper-toolbar">
                        <label>Size <input id="minesweeper-size" type="number" min="5" max="12" value="8" style="width:32px;"></label>
                        <label>Mines <input id="minesweeper-mines" type="number" min="5" max="20" value="10" style="width:32px;"></label>
                        <button class="btn" id="minesweeper-restart">Restart</button>
                    </div>
                    <div class="minesweeper-status" id="minesweeper-status"></div>
                    <div class="minesweeper-board" id="minesweeper-board"></div>
                </div>
            </div>
        </div>
        <!-- Scientific Calculator App Window -->
        <div class="window" id="scicalc-window" style="width: 260px; height: 220px; top: 460px; left: 460px; display:none;">
            <div class="window-header">
                <span class="window-title">Scientific Calculator</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding: 10px;">
                <div class="scicalc-container">
                    <div id="scicalc-display" class="scicalc-display">0</div>
                    <div class="scicalc-buttons" id="scicalc-buttons"></div>
                    <div class="scicalc-history" id="scicalc-history"></div>
                </div>
            </div>
        </div>
        <!-- Tic-Tac-Toe App Window (now loads external game in iframe) -->
        <div class="window" id="tictactoe-window" style="width: 600px; height: 700px; top: 500px; left: 500px; display:none;">
            <div class="window-header">
                <span class="window-title">Tic-Tac-Toe</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding:0;display:flex;flex-direction:column;height:100%;">
                <!-- Loads user's Tic-Tac-Toe game directly in an iframe -->
                <iframe id="tictactoe-iframe"
                    src="https://ayush200629.github.io/tic-tac-toe/"
                    style="width:100%;height:100%;border:none;display:block;border-radius:8px;box-shadow:0 2px 8px #0002;"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                    loading="lazy"
                ></iframe>
            </div>
        </div>
        <div class="window" id="protrade-window" style="width: 1000px; height: 700px; top: 80px; left: 80px; display:none;">
            <div class="window-header">
                <span class="window-title">ProTrade</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding:0;display:flex;flex-direction:column;height:100%;">
                <!-- ProTrade app loads directly in this iframe -->
                <iframe id="protrade-iframe"
                    src="https://sachin844123.github.io/ProTrading/"
                    style="width:100%;height:100%;border:none;display:block;border-radius:8px;box-shadow:0 2px 8px #0002;"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                    loading="lazy"
                ></iframe>
            </div>
        </div>
        <!-- Reciepy App Window -->
        <div class="window" id="reciepy-window" style="width: 900px; height: 700px; top: 120px; left: 120px; display:none;">
            <div class="window-header">
                <span class="window-title">Reciepy</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding:0;display:flex;flex-direction:column;height:100%;">
                <iframe id="reciepy-iframe"
                    src="reciepy/index.html.html"
                    style="width:100%;height:100%;border:none;display:block;border-radius:8px;box-shadow:0 2px 8px #0002;"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                    loading="lazy"
                ></iframe>
            </div>
        </div>
        <!-- Shoppy.com App Window -->
        <div class="window" id="shoppy-window" style="width: 1200px; height: 800px; top: 60px; left: 60px; display:none;">
            <div class="window-header">
                <span class="window-title">shoppy.com</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding:0;display:flex;flex-direction:column;height:100%;">
                <iframe id="shoppy-iframe"
                    src="amazon front page clone/index.html"
                    style="width:100%;height:100%;border:none;display:block;border-radius:8px;box-shadow:0 2px 8px #0002;"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                    loading="lazy"
                ></iframe>
            </div>
        </div>
        <!-- Maze Game App Window -->
        <div class="window" id="maze-window" style="width: 900px; height: 700px; top: 120px; left: 180px; display:none;">
            <div class="window-header">
                <span class="window-title">Maze Game</span>
                <div class="window-controls">
                    <div class="window-control minimize">-</div>
                    <div class="window-control maximize">+</div>
                    <div class="window-control close"></div>
                </div>
            </div>
            <div class="window-content" style="padding:0;height:100%;display:flex;flex-direction:column;">
                <iframe src="maze.html" style="width:100%;height:100%;border:none;border-radius:0 0 18px 18px;overflow:hidden;"></iframe>
            </div>
        </div>
    </div>

    <div id="context-menu" class="context-menu">
        <ul>
            <li id="context-new-note"> New Note</li>
            <li id="context-change-wallpaper"> Change Wallpaper</li>
            <li id="context-open-terminal"> Open Terminal</li>
            <li id="context-new-folder"> New Folder</li>
        </ul>
    </div>

    <!-- Windows 11 Start Menu (hidden by default) -->
    <div class="start-menu" id="start-menu">
        <h2>Start</h2>
        <div class="start-apps">
            <div class="start-app" data-app="notes"><div class="start-app-icon"></div><div class="start-app-label">Notes</div></div>
            <div class="start-app" data-app="music"><div class="start-app-icon"></div><div class="start-app-label">Music</div></div>
            <div class="start-app" data-app="calendar"><div class="start-app-icon"></div><div class="start-app-label">Calendar</div></div>
            <div class="start-app" data-app="terminal"><div class="start-app-icon"></div><div class="start-app-label">Terminal</div></div>
            <div class="start-app" data-app="settings"><div class="start-app-icon"></div><div class="start-app-label">Settings</div></div>
            <div class="start-app" data-app="calculator"><div class="start-app-icon"></div><div class="start-app-label">Calculator</div></div>
            <div class="start-app" data-app="files"><div class="start-app-icon"></div><div class="start-app-label">Files</div></div>
            <div class="start-app" data-app="browser"><div class="start-app-icon"></div><div class="start-app-label">Browser</div></div>
            <div class="start-app" data-app="paint"><div class="start-app-icon"></div><div class="start-app-label">Paint</div></div>
            <div class="start-app" data-app="gallery"><div class="start-app-icon"></div><div class="start-app-label">Gallery</div></div>
            <div class="start-app" data-app="stickynotes"><div class="start-app-icon"></div><div class="start-app-label">Sticky</div></div>
            <div class="start-app" data-app="alarm"><div class="start-app-icon"></div><div class="start-app-label">Alarm</div></div>
            <div class="start-app" data-app="minesweeper"><div class="start-app-icon"></div><div class="start-app-label">Minesweeper</div></div>
            <div class="start-app" data-app="scicalc"><div class="start-app-icon"></div><div class="start-app-label">SciCalc</div></div>
            <div class="start-app" data-app="tictactoe"><div class="start-app-icon"></div><div class="start-app-label">TicTacToe</div></div>
            <div class="start-app" data-app="protrade"><div class="start-app-icon"></div><div class="start-app-label">ProTrade</div></div>
            <div class="start-app" data-app="reciepy"><div class="start-app-icon"></div><div class="start-app-label">Reciepy</div></div>
            <div class="start-app" data-app="shoppy"><div class="start-app-icon"></div><div class="start-app-label">shoppy.com</div></div>
            <div class="start-app" data-app="maze"><div class="start-app-icon"></div><div class="start-app-label">Maze Game</div></div>
        </div>
    </div>

    <!-- Add audio elements for sound effects -->
    <audio id="powerOnSound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b7.mp3" preload="auto"></audio> <!-- Windows-like boot chime, public domain -->
    <audio id="notifSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b273b.mp3" preload="auto"></audio> <!-- Notification sound -->
    <audio id="windowSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b273b.mp3" preload="auto"></audio> <!-- Window open/close sound (same as notif for demo) -->

    <script>
        // Global variables
        let draggedWindow = null;
        let dragOffset = { x: 0, y: 0 };
        let windowZIndex = 100;
        let currentNotePath = null;
        let musicPlaying = false;
        let currentTrack = 0;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let terminalHistory = [];
        let calcExpression = '';
        let calcDisplay = '0';
        let resetCalcDisplay = false;
        let desktopIconsPositions = JSON.parse(localStorage.getItem('webos-desktop-icons') || '{}');
        let vfs = {};
        let cwd = '/Users/user';
        let fileExplorerState = { currentPath: '/Users/user', history: [], historyIndex: -1 };
        const BROWSER_HOME_PAGE = 'https://www.google.com/webhp?igu=1';

        // Music tracks
        const tracks = [
            { title: "Awesome Song", artist: "Unknown Artist" },
            { title: "Digital Dreams", artist: "Cyber Musician" },
            { title: "Neon Nights", artist: "Future Beats" },
            { title: "Code Symphony", artist: "Dev Orchestra" }
        ];

        // Initialize OS
        function initOS() {
            updateClock();
            setInterval(updateClock, 1000);
            initializeVFS();
            positionDesktopIcons();
            loadNotes();
            renderCalendar();
            loadSettings();
            setupEventListeners();
            updateTerminalPrompt();
            setupPaintApp();
            setupGalleryApp();
            setupTaskmanApp();
            setupStickyNotesApp();
            setupAlarmApp();
            setupMinesweeperApp();
            setupSciCalcApp();
            setupTicTacToeApp();
        }

        // Clock functionality
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock').textContent = timeString;
        }

        // Virtual File System
        function initializeVFS() {
            const savedVFS = localStorage.getItem('webos-vfs');
            if (savedVFS) {
                vfs = JSON.parse(savedVFS);
            } else {
                vfs = {
                    'Users': { type: 'folder', children: {
                        'user': { type: 'folder', children: {
                            'Desktop': { type: 'folder', children: {} },
                            'Documents': { type: 'folder', children: {} },
                            'Welcome.txt': { type: 'file', content: 'Welcome to WebOS! You can use terminal commands like ls, cd, mkdir, cat, and touch.' }
                        }}
                    }},
                    'System': { type: 'folder', children: {} }
                };
                saveVFS();
            }
        }

        function saveVFS() {
            localStorage.setItem('webos-vfs', JSON.stringify(vfs));
        }

        function resolvePath(path) {
            let currentPath = path.startsWith('/') ? [] : cwd.split('/').filter(p => p);
            const parts = path.split('/').filter(p => p);

            if (path.startsWith('~')) {
                currentPath = ['Users', 'user'];
                parts.shift();
            }

            for (const part of parts) {
                if (part === '..') {
                    currentPath.pop();
                } else if (part !== '.') {
                    currentPath.push(part);
                }
            }
            return '/' + currentPath.join('/');
        }

        function getNodeFromPath(path, parent = false) {
            const resolvedPath = resolvePath(path);
            const parts = resolvedPath.split('/').filter(p => p);
            let node = vfs;
            
            if (parent) parts.pop();

            for (const part of parts) {
                if (node[part] && node[part].type === 'folder') {
                    node = node[part].children;
                } else if (node[part]) {
                    node = node[part];
                } else {
                    return null;
                }
            }
            return node;
        }

        // Desktop Icon Positioning
        function positionDesktopIcons() {
            const icons = document.querySelectorAll('.desktop-icon');
            const initialPositions = [
                { top: 20, left: 20 }, { top: 20, left: 110 }, { top: 20, left: 200 },
                { top: 110, left: 20 }, { top: 110, left: 110 }, { top: 110, left: 200 },
                { top: 200, left: 20}
            ];

            icons.forEach((icon, index) => {
                const appName = icon.dataset.app;
                const savedPos = desktopIconsPositions[appName];
                if (savedPos) {
                    icon.style.top = savedPos.top + 'px';
                    icon.style.left = savedPos.left + 'px';
                } else if (initialPositions[index]) {
                    icon.style.top = initialPositions[index].top + 'px';
                    icon.style.left = initialPositions[index].left + 'px';
                }
            });
        }

        // Window management
        function openWindow(appName) {
            const window = document.getElementById(appName + '-window');
            if (window) {
                window.style.display = 'block';
                window.classList.add('window-opening');
                bringToFront(window);
                
                if (appName === 'files' && !window.dataset.initialized) {
                    renderFileExplorer(fileExplorerState.currentPath);
                    window.dataset.initialized = 'true';
                }
                if (appName === 'browser' && document.getElementById('browser-content').src === 'about:blank') {
                    navigateBrowser(BROWSER_HOME_PAGE);
                }
                if (appName === 'paint') {
                    setupPaintApp();
                }
                if (appName === 'gallery') {
                    // Gallery will auto-render on open via MutationObserver
                }
                if (appName === 'taskman') {
                    // Task Manager auto-updates
                }
                if (appName === 'stickynotes') {
                    // Sticky Notes auto-setup
                }
                if (appName === 'alarm') {
                    // Alarm app auto-setup
                }
                if (appName === 'minesweeper') {
                    // Minesweeper auto-setup
                }
                if (appName === 'scicalc') {
                    // Scientific Calculator auto-setup
                }
                if (appName === 'tictactoe') {
                    // Tic-Tac-Toe auto-setup
                }
                setTimeout(() => {
                    window.classList.remove('window-opening');
                }, 300);
            }
        }

        function closeWindow(window) {
            window.style.display = 'none';
        }

        function minimizeWindow(window) {
            window.style.display = 'none';
        }

        function maximizeWindow(window) {
            if (window.style.width === '100vw') {
                // Restore
                window.style.width = '500px';
                window.style.height = '400px';
                window.style.top = '100px';
                window.style.left = '100px';
            } else {
                // Maximize
                window.style.width = '100vw';
                window.style.height = 'calc(100vh - 50px)';
                window.style.top = '0';
                window.style.left = '0';
            }
        }

        function bringToFront(window) {
            window.style.zIndex = ++windowZIndex;
            document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
            window.classList.add('active');
        }

        // Drag functionality
        function startDrag(e, window) {
            if (e.target.classList.contains('window-control')) return;
            
            draggedWindow = window;
            const rect = window.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            bringToFront(window);
        }

        function drag(e) {
            if (!draggedWindow) return;
            
            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;
            
            draggedWindow.style.left = Math.max(0, Math.min(x, window.innerWidth - draggedWindow.offsetWidth)) + 'px';
            draggedWindow.style.top = Math.max(0, Math.min(y, window.innerHeight - draggedWindow.offsetHeight - 50)) + 'px';
        }

        function stopDrag() {
            draggedWindow = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // Notes functionality
        function loadNotes() {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';
            
            const documentsNode = getNodeFromPath('~/Documents');
            if (documentsNode && documentsNode.children) {
                Object.entries(documentsNode.children).forEach(([filename, file]) => {
                    if (filename.endsWith('.txt')) {
                const noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.innerHTML = `
                            <div class="note-title">${filename.replace('.txt', '')}</div>
                            <div class="note-preview">${file.content.substring(0, 100)}...</div>
                `;
                        noteElement.addEventListener('click', () => editNote(`~/Documents/${filename}`));
                notesList.appendChild(noteElement);
                    }
            });
            }
        }

        function newNote() {
            currentNotePath = null;
            document.getElementById('note-title-input').value = '';
            document.getElementById('note-content-input').value = '';
            showNoteEditor();
        }

        function editNote(filePath) {
            currentNotePath = filePath;
            const noteNode = getNodeFromPath(filePath);
            if (noteNode && noteNode.type === 'file') {
                const pathParts = filePath.split('/');
                const filename = pathParts[pathParts.length - 1];
                document.getElementById('note-title-input').value = filename.replace('.txt', '');
                document.getElementById('note-content-input').value = noteNode.content;
            showNoteEditor();
            }
        }

        function saveNote() {
            const title = document.getElementById('note-title-input').value.trim() || 'Untitled';
            const content = document.getElementById('note-content-input').value;
            const filename = title.replace(/[\\/:*?"<>|]/g, '') + '.txt'; // Sanitize filename
            const docsPath = '~/Documents';
            const filePath = `${docsPath}/${filename}`;
            
            // If it's a new note or renamed note, check for existence
            if (currentNotePath !== filePath) {
                const existingNote = getNodeFromPath(filePath);
                if (existingNote) {
                    if (!confirm('A note with this title already exists. Overwrite it?')) {
                        return;
                    }
                }
                // If it was an existing note that was renamed, remove the old file
                if (currentNotePath) {
                    const oldPathParts = currentNotePath.split('/');
                    const oldFilename = oldPathParts.pop();
                    const oldParentNode = getNodeFromPath(oldPathParts.join('/'), true);
                    const oldParentChildren = getNodeFromPath(oldPathParts.join('/'));
                    if(oldParentChildren && oldParentChildren[oldFilename]){
                        delete oldParentChildren[oldFilename];
                    }
                }
            }
            
            const documentsNode = getNodeFromPath(docsPath, true);
            const children = getNodeFromPath(docsPath);
            if (children) {
                children[filename] = {
                    type: 'file',
                    content: content
                };
                saveVFS();
            loadNotes();
            hideNoteEditor();
                // Refresh file explorer if open
                if (document.getElementById('files-window').style.display === 'block') {
                    renderFileExplorer(fileExplorerState.currentPath);
                }
            } else {
                showNotification('Error', 'Could not save note. Documents folder not found.', 4000);
            }
        }

        function showNoteEditor() {
            document.getElementById('notes-list').style.display = 'none';
            document.getElementById('note-editor').style.display = 'flex';
            document.getElementById('new-note-btn').style.display = 'none';
            document.getElementById('save-note-btn').style.display = 'inline-block';
            document.getElementById('back-to-notes-btn').style.display = 'inline-block';
        }

        function hideNoteEditor() {
            document.getElementById('notes-list').style.display = 'block';
            document.getElementById('note-editor').style.display = 'none';
            document.getElementById('new-note-btn').style.display = 'inline-block';
            document.getElementById('save-note-btn').style.display = 'none';
            document.getElementById('back-to-notes-btn').style.display = 'none';
        }

        // Music player functionality
        function toggleMusic() {
            musicPlaying = !musicPlaying;
            const playBtn = document.getElementById('play-btn');
            playBtn.textContent = musicPlaying ? '' : '';
            
            if (musicPlaying) {
                startProgress();
            }
        }

        function nextTrack() {
            currentTrack = (currentTrack + 1) % tracks.length;
            updateTrackInfo();
        }

        function prevTrack() {
            currentTrack = (currentTrack - 1 + tracks.length) % tracks.length;
            updateTrackInfo();
        }

        function updateTrackInfo() {
            document.getElementById('track-title').textContent = tracks[currentTrack].title;
            document.getElementById('track-artist').textContent = tracks[currentTrack].artist;
            document.getElementById('progress').style.width = '0%';
        }

        function startProgress() {
            if (!musicPlaying) return;
            
            let progress = 0;
            const interval = setInterval(() => {
                if (!musicPlaying) {
                    clearInterval(interval);
                    return;
                }
                
                progress += 0.5;
                document.getElementById('progress').style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    nextTrack();
                    if (musicPlaying) startProgress();
                }
            }, 100);
        }

        // Calendar functionality
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById('current-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            
            grid.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day';
                header.style.fontWeight = 'bold';
                header.style.background = '#f5f5f5';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                if (currentYear === today.getFullYear() && 
                    currentMonth === today.getMonth() && 
                    day === today.getDate()) {
                    dayElement.classList.add('today');
                }
                
                grid.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        // Terminal functionality
        function updateTerminalPrompt() {
            const prompt = document.querySelector('#terminal .new-prompt-line .terminal-prompt');
            if (prompt) {
                let displayPath = cwd.startsWith('/Users/user') ? '~' + cwd.substring('/Users/user'.length) : cwd;
                if(displayPath === '') displayPath = '/';
                prompt.textContent = `user@webos:${displayPath}$ `;
            }
        }

        function processCommand(fullCommand) {
            const terminal = document.getElementById('terminal');
            const [command, ...args] = fullCommand.trim().split(/\s+/);
            
            const currentPromptLine = terminal.querySelector('.new-prompt-line');
            currentPromptLine.classList.remove('new-prompt-line');
            const promptText = currentPromptLine.querySelector('.terminal-prompt').textContent;
            currentPromptLine.innerHTML = `<span class="terminal-prompt">${promptText}</span>${fullCommand}`;

            const commands = {
                help: () => "Available commands: help, clear, ls, cd, pwd, cat, touch, mkdir, echo",
                clear: () => {
                    const lines = terminal.querySelectorAll('.terminal-line:not(.new-prompt-line)');
                lines.forEach(line => line.remove());
                    return '';
                },
                pwd: () => cwd,
                ls: () => {
                    const path = args[0] || cwd;
                    const node = getNodeFromPath(path);
                    if (node && node.children) {
                        return Object.keys(node.children).map(name => {
                            return node.children[name].type === 'folder' ? `${name}/` : name;
                        }).join('  ');
                    }
                    return `ls: cannot access '${path}': No such file or directory`;
                },
                cd: () => {
                    const targetPath = args[0] || '/Users/user';
                    const newPath = resolvePath(targetPath);
                    const node = getNodeFromPath(newPath);
                    if (node && (node.children || newPath === '/')) {
                        cwd = newPath;
                        return '';
                    }
                    return `cd: no such file or directory: ${targetPath}`;
                },
                cat: () => {
                    const path = resolvePath(args[0]);
                    const node = getNodeFromPath(path);
                    if (node && node.type === 'file') {
                        return node.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    }
                    return `cat: ${args[0]}: No such file or directory`;
                },
                touch: () => {
                    const path = resolvePath(args[0]);
                    const parts = path.split('/').filter(p => p);
                    const filename = parts.pop();
                    const parentDir = getNodeFromPath(parts.join('/'));
                    if (parentDir && parentDir.children && !parentDir.children[filename]) {
                        parentDir.children[filename] = { type: 'file', content: '' };
                        saveVFS();
                        return '';
                    }
                    return `touch: cannot touch '${args[0]}': File exists or invalid path`;
                },
                mkdir: () => {
                    const path = resolvePath(args[0]);
                    const parts = path.split('/').filter(p => p);
                    const dirname = parts.pop();
                    const parentDir = getNodeFromPath(parts.join('/'));
                    if (parentDir && parentDir.children && !parentDir.children[dirname]) {
                        parentDir.children[dirname] = { type: 'folder', children: {} };
                        saveVFS();
                        return '';
                    }
                    return `mkdir: cannot create directory '${args[0]}': File exists or invalid path`;
                },
                echo: () => {
                    return args.join(' ');
                }
            };

            let output = '';
            if (commands[command]) {
                output = commands[command]();
            } else if (command.trim() !== '') {
                output = `Command not found: ${command}`;
            }

            if (output) addTerminalOutput(output);
            
            const newPrompt = document.createElement('div');
            newPrompt.className = 'terminal-line new-prompt-line';
            newPrompt.innerHTML = `<span class="terminal-prompt"></span><input type="text" class="terminal-input">`;
            terminal.appendChild(newPrompt);
            newPrompt.querySelector('input').focus();
            newPrompt.querySelector('input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') processCommand(e.target.value);
            });

            updateTerminalPrompt();
            terminal.scrollTop = terminal.scrollHeight;
        }

        function addTerminalOutput(output) {
            const terminal = document.getElementById('terminal');
            const outputLine = document.createElement('div');
            outputLine.className = 'terminal-line';
            outputLine.textContent = output;
            terminal.insertBefore(outputLine, terminal.querySelector('.new-prompt-line'));
        }

        // Settings functionality
        function loadSettings() {
            const savedWallpaper = localStorage.getItem('webos-wallpaper');
            if (savedWallpaper) {
                setWallpaper(savedWallpaper);
            }
        }

        function setWallpaper(wallpaper) {
            document.getElementById('desktop').style.backgroundImage = wallpaper;
            localStorage.setItem('webos-wallpaper', wallpaper);
            
            // Update selected wallpaper option
            document.querySelectorAll('.wallpaper-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.wallpaper === wallpaper) {
                    option.classList.add('selected');
                }
            });
        }

        // Calculator functionality
        function processCalculatorInput(value) {
            const displayEl = document.getElementById('calc-display');

            if (resetCalcDisplay && !['+', '-', '*', '/'].includes(value) && value !== '=') {
                calcExpression = '';
                calcDisplay = '0';
                resetCalcDisplay = false;
            }

            switch (value) {
                case 'clear':
                    calcExpression = '';
                    calcDisplay = '0';
                    break;
                case 'backspace':
                    if (calcDisplay.length > 1 && calcDisplay !== 'Error') {
                        calcDisplay = calcDisplay.slice(0, -1);
                        calcExpression = calcExpression.slice(0, -1);
                    } else {
                        calcDisplay = '0';
                        calcExpression = '';
                    }
                    break;
                case '=':
                    if(calcExpression === '') break;
                    try {
                        const result = new Function('return ' + calcExpression.replace(/--/g, '+'))();
                        calcDisplay = String(result);
                        calcExpression = String(result);
                        resetCalcDisplay = true;
                    } catch {
                        calcDisplay = 'Error';
                        calcExpression = '';
                        resetCalcDisplay = true;
                    }
                    break;
                case '+':
                case '-':
                case '*':
                case '/':
                    if (calcExpression.length > 0) {
                         const lastChar = calcExpression.slice(-1);
                         if(['+', '-', '*', '/'].includes(lastChar)) {
                            calcExpression = calcExpression.slice(0, -1) + value;
                            calcDisplay = calcDisplay.slice(0, -1) + (value === '*' ? '' : value === '/' ? '' : value);
                         } else {
                            calcExpression += value;
                            calcDisplay += (value === '*' ? '' : value === '/' ? '' : value);
                         }
                    } else if (value === '-') {
                        calcExpression += value;
                        calcDisplay = value;
                    }
                    break;
                default: // Numbers and dot
                    if (calcDisplay === '0' && value !== '.') {
                        calcDisplay = value;
                        calcExpression = value;
                    } else {
                        calcDisplay += value;
                        calcExpression += value;
                    }
                    break;
            }
            displayEl.textContent = calcDisplay.substring(0, 15);
        }

        // Event listeners setup
        function setupEventListeners() {
            // App icons (both desktop and taskbar)
            document.querySelectorAll('[data-app]').forEach(icon => {
                // Taskbar icons: open windows on click
                if (icon.classList.contains('app-icon')) {
                    icon.addEventListener('click', (e) => {
                        openWindow(e.currentTarget.dataset.app);
                    });
                }
                // Desktop icons: open windows on double-click
                if (icon.classList.contains('desktop-icon')) {
                    icon.addEventListener('dblclick', (e) => {
                        openWindow(e.currentTarget.dataset.app);
                    });
                }
            });

            // Draggable desktop icons
            document.querySelectorAll('.desktop-icon').forEach(icon => {
                let dragInfo = { isDragging: false, wasDragged: false, startX: 0, startY: 0, offsetX: 0, offsetY: 0 };

                icon.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    
                    dragInfo.isDragging = true;
                    dragInfo.wasDragged = false;
                    dragInfo.startX = e.clientX;
                    dragInfo.startY = e.clientY;

                    const rect = icon.getBoundingClientRect();
                    dragInfo.offsetX = e.clientX - rect.left;
                    dragInfo.offsetY = e.clientY - rect.top;

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                function onMouseMove(e) {
                    if (!dragInfo.isDragging) return;
                    if (Math.abs(e.clientX - dragInfo.startX) > 5 || Math.abs(e.clientY - dragInfo.startY) > 5) {
                        dragInfo.wasDragged = true;
                    }
                    
                    icon.style.transition = 'none';
                    const desktop = document.getElementById('desktop');
                    const desktopRect = desktop.getBoundingClientRect();
                    let newLeft = e.clientX - desktopRect.left - dragInfo.offsetX;
                    let newTop = e.clientY - desktopRect.top - dragInfo.offsetY;

                    newLeft = Math.max(0, Math.min(newLeft, desktop.offsetWidth - icon.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, desktop.offsetHeight - icon.offsetHeight - 50));

                    icon.style.left = newLeft + 'px';
                    icon.style.top = newTop + 'px';
                }

                function onMouseUp() {
                    if (!dragInfo.isDragging) return;
                    dragInfo.isDragging = false;
                    icon.style.transition = 'top 0.3s ease, left 0.3s ease, transform 0.3s ease';

                    if (dragInfo.wasDragged) {
                        // Snap to grid
                        const gridSize = 90;
                        const gridOffset = 20;

                        let finalLeft = Math.round((icon.offsetLeft - gridOffset) / gridSize) * gridSize + gridOffset;
                        let finalTop = Math.round((icon.offsetTop - gridOffset) / gridSize) * gridSize + gridOffset;
                        
                        // Constrain to desktop bounds
                        const desktop = document.getElementById('desktop');
                        finalLeft = Math.max(gridOffset, Math.min(finalLeft, desktop.offsetWidth - icon.offsetWidth));
                        finalTop = Math.max(gridOffset, Math.min(finalTop, desktop.offsetHeight - icon.offsetHeight - 50));
                        
                        icon.style.left = finalLeft + 'px';
                        icon.style.top = finalTop + 'px';

                        const appName = icon.dataset.app;
                        desktopIconsPositions[appName] = { left: finalLeft, top: finalTop };
                        localStorage.setItem('webos-desktop-icons', JSON.stringify(desktopIconsPositions));
                    }

                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                icon.addEventListener('click', (e) => {
                    if (dragInfo.wasDragged) {
                        e.preventDefault();
                        e.stopPropagation();
                    } else {
                        openWindow(e.currentTarget.dataset.app);
                    }
                }, true);
            });

            // Window controls
            document.querySelectorAll('.window').forEach(window => {
                const header = window.querySelector('.window-header');
                const controls = window.querySelectorAll('.window-control');
                
                // Drag functionality
                header.addEventListener('mousedown', (e) => startDrag(e, window));
                
                // Click to bring to front
                window.addEventListener('mousedown', () => bringToFront(window));
                
                // Window controls
                controls[0].addEventListener('click', () => minimizeWindow(window)); // Minimize
                controls[1].addEventListener('click', () => maximizeWindow(window)); // Maximize
                controls[2].addEventListener('click', () => closeWindow(window)); // Close
            });

            // Notes app
            document.getElementById('new-note-btn').addEventListener('click', newNote);
            document.getElementById('save-note-btn').addEventListener('click', saveNote);
            document.getElementById('back-to-notes-btn').addEventListener('click', hideNoteEditor);

            // Music player
            document.getElementById('play-btn').addEventListener('click', toggleMusic);
            document.getElementById('next-btn').addEventListener('click', nextTrack);
            document.getElementById('prev-btn').addEventListener('click', prevTrack);

            // Calendar
            document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

            // Terminal
            document.getElementById('terminal-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    processCommand(e.target.value);
                    e.target.remove();
                }
            });

            // Settings - Wallpaper
            document.querySelectorAll('.wallpaper-option').forEach(option => {
                option.addEventListener('click', () => {
                    setWallpaper(option.dataset.wallpaper);
                });
            });

            // Desktop context menu
            const desktop = document.getElementById('desktop');
            const contextMenu = document.getElementById('context-menu');

            desktop.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const x = e.clientX;
                const y = e.clientY;
                const menuWidth = contextMenu.offsetWidth;
                const menuHeight = contextMenu.offsetHeight;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;

                const newX = x + menuWidth > screenWidth ? screenWidth - menuWidth - 5 : x;
                const newY = y + menuHeight > screenHeight ? screenHeight - menuHeight - 5 : y;

                contextMenu.style.left = `${newX}px`;
                contextMenu.style.top = `${newY}px`;
                contextMenu.style.display = 'block';
            });

            document.getElementById('context-new-note').addEventListener('click', () => {
                openWindow('notes');
                setTimeout(newNote, 50);
                contextMenu.style.display = 'none';
            });

            document.getElementById('context-change-wallpaper').addEventListener('click', () => {
                openWindow('settings');
                contextMenu.style.display = 'none';
            });

            document.getElementById('context-open-terminal').addEventListener('click', () => {
                openWindow('terminal');
                contextMenu.style.display = 'none';
            });

            document.getElementById('context-new-folder').addEventListener('click', () => {
                const folderName = prompt('Enter folder name:');
                if (folderName) {
                    const newFolder = { type: 'folder', children: {} };
                    const desktopNode = getNodeFromPath('~/Desktop');
                    desktopNode.children[folderName] = newFolder;
                    saveVFS();
                    renderDesktopIcons();
                }
                contextMenu.style.display = 'none';
            });

            // Click anywhere to hide context menu
            document.addEventListener('click', (e) => {
                if (e.target.offsetParent !== contextMenu) {
                    contextMenu.style.display = 'none';
                }
            });

            // Click desktop to deselect windows
            desktop.addEventListener('click', (e) => {
                if (e.target.id === 'desktop') {
                    document.querySelectorAll('.window').forEach(w => w.classList.remove('active'));
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Alt + Tab to cycle windows
                if (e.altKey && e.key === 'Tab') {
                    e.preventDefault();
                    const visibleWindows = Array.from(document.querySelectorAll('.window'))
                        .filter(w => w.style.display !== 'none');
                    if (visibleWindows.length > 1) {
                        const activeWindow = document.querySelector('.window.active');
                        const currentIndex = visibleWindows.indexOf(activeWindow);
                        const nextIndex = (currentIndex + 1) % visibleWindows.length;
                        bringToFront(visibleWindows[nextIndex]);
                    }
                }
                
                // Ctrl + N for new note (when notes window is active)
                if (e.ctrlKey && e.key === 'n' && document.querySelector('#notes-window.active')) {
                    e.preventDefault();
                    newNote();
                }
            });

            // Window resize functionality
            document.querySelectorAll('.window').forEach(window => {
                // Add resize handle
                const resizeHandle = document.createElement('div');
                resizeHandle.style.cssText = `
            position: absolute;
                    bottom: 0;
                    right: 0;
                    width: 20px;
                    height: 20px;
                    cursor: se-resize;
                    background: linear-gradient(-45deg, transparent 40%, #ccc 40%, #ccc 60%, transparent 60%);
                `;
                window.appendChild(resizeHandle);

                let isResizing = false;
                let startX, startY, startWidth, startHeight;

                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = parseInt(document.defaultView.getComputedStyle(window).width, 10);
                    startHeight = parseInt(document.defaultView.getComputedStyle(window).height, 10);
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    
                    const width = startWidth + e.clientX - startX;
                    const height = startHeight + e.clientY - startY;
                    
                    window.style.width = Math.max(300, width) + 'px';
                    window.style.height = Math.max(200, height) + 'px';
                });

                document.addEventListener('mouseup', () => {
                    isResizing = false;
                });
            });

            // Calculator
            document.querySelectorAll('.calc-btn').forEach(button => {
                button.addEventListener('click', () => {
                    processCalculatorInput(button.dataset.value);
                });
            });

            // File Explorer Navigation
            document.getElementById('fe-back-btn').addEventListener('click', () => {
                if (fileExplorerState.historyIndex > 0) {
                    fileExplorerState.historyIndex--;
                    renderFileExplorer(fileExplorerState.history[fileExplorerState.historyIndex]);
                }
            });
            document.getElementById('fe-forward-btn').addEventListener('click', () => {
                if (fileExplorerState.historyIndex < fileExplorerState.history.length - 1) {
                    fileExplorerState.historyIndex++;
                    renderFileExplorer(fileExplorerState.history[fileExplorerState.historyIndex]);
                }
            });
            document.getElementById('fe-up-btn').addEventListener('click', () => {
                if (fileExplorerState.currentPath !== '/') {
                    const parentPath = fileExplorerState.currentPath.substring(0, fileExplorerState.currentPath.lastIndexOf('/')) || '/';
                    renderFileExplorer(parentPath);
                }
            });

            // Browser controls
            const browserWindow = document.getElementById('browser-window');
            if (!browserWindow) return;
            const browserAddressBar = document.getElementById('browser-address-bar');
            const browserIframe = document.getElementById('browser-content');
            const backBtn = document.getElementById('browser-back-btn');
            const forwardBtn = document.getElementById('browser-forward-btn');
            const refreshBtn = document.getElementById('browser-refresh-btn');
            const homeBtn = document.getElementById('browser-home-btn');

            function navigateBrowser(url) {
                let finalUrl;
                try {
                    if (!url.startsWith('http://') && !url.startsWith('https://')) {
                        new URL('https://' + url);
                        finalUrl = 'https://' + url;
                    } else {
                        new URL(url);
                        finalUrl = url;
                    }
                } catch (_) {
                    finalUrl = `https://www.google.com/search?q=${encodeURIComponent(url)}`;
                }
                browserIframe.src = finalUrl;
                browserAddressBar.value = finalUrl;
            }

            browserAddressBar.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    navigateBrowser(browserAddressBar.value);
                }
            });
            backBtn.addEventListener('click', () => {
                try { browserIframe.contentWindow.history.back(); } catch (e) {}
            });
            forwardBtn.addEventListener('click', () => {
                try { browserIframe.contentWindow.history.forward(); } catch (e) {}
            });
            refreshBtn.addEventListener('click', () => {
                try { browserIframe.contentWindow.location.reload(); } catch (e) {}
            });
            homeBtn.addEventListener('click', () => {
                browserIframe.src = BROWSER_HOME_PAGE;
                browserAddressBar.value = '';
            });
            browserWindow.addEventListener('mousedown', () => {
                setTimeout(() => browserAddressBar.focus(), 100);
            });
            browserIframe.addEventListener('load', () => {
                try {
                    const newUrl = browserIframe.contentWindow.location.href;
                    if (newUrl !== 'about:blank') {
                        browserAddressBar.value = newUrl;
                    }
                } catch (e) {}
            });
            // Set homepage on first open
            if (browserIframe.src === 'about:blank') {
                browserIframe.src = BROWSER_HOME_PAGE;
            }

            // --- Windows 11 Start Menu Logic ---
            // Toggle start menu
            document.getElementById('start-button').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('start-menu').classList.toggle('active');
            });
            // Hide start menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#start-menu') && !e.target.closest('#start-button')) {
                    document.getElementById('start-menu').classList.remove('active');
                }
            });
            // Launch app from start menu
            document.querySelectorAll('.start-app').forEach(app => {
                app.addEventListener('click', () => {
                    openWindow(app.dataset.app);
                    document.getElementById('start-menu').classList.remove('active');
                });
            });

            // No launch button for ProTrade, iframe loads directly
            // ... other app-specific event listeners ...
        }

        // File Explorer
        function renderFileExplorer(path) {
            const mainView = document.getElementById('fe-main-view');
            const addressBar = document.getElementById('fe-address-bar');
            mainView.innerHTML = '';
            
            const node = getNodeFromPath(path);
            if (!node || !node.children) {
                mainView.innerHTML = 'Folder not found.';
                return;
            }

            fileExplorerState.currentPath = path;
            addressBar.value = path;
            
            if (fileExplorerState.history[fileExplorerState.historyIndex] !== path) {
                fileExplorerState.history.splice(fileExplorerState.historyIndex + 1);
                fileExplorerState.history.push(path);
                fileExplorerState.historyIndex++;
            }
            updateFileExplorerNav();

            for (const [name, item] of Object.entries(node.children)) {
                const feItem = document.createElement('div');
                feItem.className = 'fe-item';
                feItem.dataset.name = name;
                feItem.dataset.type = item.type;
                
                const icon = item.type === 'folder' ? '' : '';
                feItem.innerHTML = `<div class="fe-icon">${icon}</div><div class="fe-name">${name}</div>`;
                
                feItem.addEventListener('dblclick', () => {
                    if (item.type === 'folder') {
                        const newPath = (path === '/' ? '' : path) + '/' + name;
                        renderFileExplorer(newPath);
                    } else {
                        showNotification(`Content of ${name}`, item.content.replace(/</g, "&lt;").replace(/>/g, "&gt;"), 5000);
                    }
                });
                // --- Add right-click context menu ---
                feItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showFEContextMenu(e, name, item.type);
                });
                mainView.appendChild(feItem);
            }
        }

        function updateFileExplorerNav() {
            document.getElementById('fe-back-btn').disabled = fileExplorerState.historyIndex <= 0;
            document.getElementById('fe-forward-btn').disabled = fileExplorerState.historyIndex >= fileExplorerState.history.length - 1;
            document.getElementById('fe-up-btn').disabled = fileExplorerState.currentPath === '/';
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initOS();
            addSoundEffects();
            setupAutoSave();
            setupTimeFeatures();
            showWelcome();
            
            // Set initial track info
            updateTrackInfo();
            
            // Focus terminal input when terminal window becomes active
            const terminalWindow = document.getElementById('terminal-window');
            const terminalInput = document.getElementById('terminal-input');
            
            terminalWindow.addEventListener('mousedown', () => {
                setTimeout(() => terminalInput.focus(), 100);
            });
        });

        // Service worker registration for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Simple service worker for caching (inline for demo)
                const swCode = `
                    const CACHE_NAME = 'webos-v1';
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then(() => {
                    console.log('WebOS Service Worker registered');
                }).catch(() => {
                    console.log('Service Worker registration failed');
                });
            });
        }

        // --- Windows 11 Snap Layouts ---
        // Snap logic variables
        let snapPreview = document.getElementById('snap-preview');
        let snapTarget = null;
        let snapType = null;

        // Enhance drag functionality for snap
        function startDrag(e, window) {
            if (e.target.classList.contains('window-control')) return;
            draggedWindow = window;
            const rect = window.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            document.addEventListener('mousemove', dragWithSnap);
            document.addEventListener('mouseup', stopDragWithSnap);
            bringToFront(window);
        }

        // Drag with snap preview
        function dragWithSnap(e) {
            if (!draggedWindow) return;
            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;
            const winW = draggedWindow.offsetWidth;
            const winH = draggedWindow.offsetHeight;
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;
            // Snap detection area (in px)
            const edge = 32;
            let snap = null;
            // Snap left
            if (e.clientX < edge) snap = 'left';
            // Snap right
            else if (e.clientX > screenW - edge) snap = 'right';
            // Snap top (maximize)
            else if (e.clientY < edge) snap = 'top';
            // Show snap preview
            if (snap) {
                snapType = snap;
                snapPreview.style.display = 'block';
                if (snap === 'left') {
                    snapPreview.style.left = '0px';
                    snapPreview.style.top = '0px';
                    snapPreview.style.width = (screenW/2) + 'px';
                    snapPreview.style.height = (screenH - 56) + 'px';
                } else if (snap === 'right') {
                    snapPreview.style.left = (screenW/2) + 'px';
                    snapPreview.style.top = '0px';
                    snapPreview.style.width = (screenW/2) + 'px';
                    snapPreview.style.height = (screenH - 56) + 'px';
                } else if (snap === 'top') {
                    snapPreview.style.left = '0px';
                    snapPreview.style.top = '0px';
                    snapPreview.style.width = screenW + 'px';
                    snapPreview.style.height = (screenH - 56) + 'px';
                }
            } else {
                snapType = null;
                snapPreview.style.display = 'none';
            }
            // Move window (if not snapping)
            if (!snapType) {
                draggedWindow.style.left = Math.max(0, Math.min(x, screenW - winW)) + 'px';
                draggedWindow.style.top = Math.max(0, Math.min(y, screenH - winH - 56)) + 'px';
            }
        }

        // Stop drag and snap if needed
        function stopDragWithSnap() {
            if (!draggedWindow) return;
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;
            if (snapType === 'left') {
                draggedWindow.style.left = '0px';
                draggedWindow.style.top = '0px';
                draggedWindow.style.width = (screenW/2) + 'px';
                draggedWindow.style.height = (screenH - 56) + 'px';
            } else if (snapType === 'right') {
                draggedWindow.style.left = (screenW/2) + 'px';
                draggedWindow.style.top = '0px';
                draggedWindow.style.width = (screenW/2) + 'px';
                draggedWindow.style.height = (screenH - 56) + 'px';
            } else if (snapType === 'top') {
                draggedWindow.style.left = '0px';
                draggedWindow.style.top = '0px';
                draggedWindow.style.width = screenW + 'px';
                draggedWindow.style.height = (screenH - 56) + 'px';
            }
            snapPreview.style.display = 'none';
            snapType = null;
            draggedWindow = null;
            document.removeEventListener('mousemove', dragWithSnap);
            document.removeEventListener('mouseup', stopDragWithSnap);
        }

        // Replace all window drag event listeners to use snap
        document.querySelectorAll('.window').forEach(window => {
            const header = window.querySelector('.window-header');
            header.addEventListener('mousedown', (e) => startDrag(e, window));
        });

        // --- Windows 11 Desktop Widgets ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Widgets Panel Movable Logic ---
            const widgetsPanel = document.getElementById('widgets-panel');
            const widgetsDrag = document.getElementById('widgets-drag');
            // Restore position from localStorage
            let panelPos = JSON.parse(localStorage.getItem('webos-widgets-pos') || 'null');
            if (panelPos && typeof panelPos.x === 'number' && typeof panelPos.y === 'number') {
                widgetsPanel.style.right = '';
                widgetsPanel.style.left = '';
                widgetsPanel.style.top = panelPos.y + 'px';
                widgetsPanel.style.right = (window.innerWidth - panelPos.x - widgetsPanel.offsetWidth) + 'px';
            }
            let isDraggingPanel = false, dragStartX = 0, dragStartY = 0, origX = 0, origY = 0;
            widgetsDrag.addEventListener('mousedown', (e) => {
                isDraggingPanel = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                const rect = widgetsPanel.getBoundingClientRect();
                origX = rect.left;
                origY = rect.top;
                widgetsPanel.style.transition = 'none';
                document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDraggingPanel) return;
                let newX = origX + (e.clientX - dragStartX);
                let newY = origY + (e.clientY - dragStartY);
                // Keep within viewport
                newX = Math.max(0, Math.min(newX, window.innerWidth - widgetsPanel.offsetWidth));
                newY = Math.max(0, Math.min(newY, window.innerHeight - widgetsPanel.offsetHeight - 56));
                widgetsPanel.style.left = newX + 'px';
                widgetsPanel.style.right = '';
                widgetsPanel.style.top = newY + 'px';
                // Save position
                localStorage.setItem('webos-widgets-pos', JSON.stringify({ x: newX, y: newY }));
            });
            document.addEventListener('mouseup', () => {
                isDraggingPanel = false;
                widgetsPanel.style.transition = '';
                document.body.style.userSelect = '';
            });
            // On window resize, reset to right if out of bounds
            window.addEventListener('resize', () => {
                const rect = widgetsPanel.getBoundingClientRect();
                if (rect.left + 80 > window.innerWidth || rect.top + 80 > window.innerHeight) {
                    widgetsPanel.style.left = '';
                    widgetsPanel.style.right = '32px';
                    widgetsPanel.style.top = '48px';
                    localStorage.removeItem('webos-widgets-pos');
                }
            });

            // --- Widgets Panel Features ---
            // Quick Notes Widget (syncs with Notes app, saves to localStorage)
            const quickNoteInput = document.getElementById('quick-note-input');
            quickNoteInput.value = localStorage.getItem('webos-quick-note') || '';
            quickNoteInput.addEventListener('input', () => {
                localStorage.setItem('webos-quick-note', quickNoteInput.value);
            });

            // To-Do List Widget
            const todoListEl = document.getElementById('todo-list');
            const todoInput = document.getElementById('todo-input');
            let todos = JSON.parse(localStorage.getItem('webos-todos') || '[]');
            function renderTodos() {
                todoListEl.innerHTML = '';
                todos.forEach((todo, idx) => {
                    const li = document.createElement('li');
                    li.style.listStyle = 'square';
                    li.style.marginBottom = '2px';
                    li.innerHTML = `<input type='checkbox' ${todo.done ? 'checked' : ''} style='margin-right:5px;'>${todo.text} <span style='color:#aaa; cursor:pointer; margin-left:6px;' title='Delete'>&times;</span>`;
                    li.querySelector('input').addEventListener('change', e => {
                        todos[idx].done = e.target.checked;
                        saveTodos();
                    });
                    li.querySelector('span').addEventListener('click', () => {
                        todos.splice(idx, 1);
                        saveTodos();
                    });
                    todoListEl.appendChild(li);
                });
            }
            function saveTodos() {
                localStorage.setItem('webos-todos', JSON.stringify(todos));
                renderTodos();
            }
            todoInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && todoInput.value.trim()) {
                    todos.push({ text: todoInput.value.trim(), done: false });
                    todoInput.value = '';
                    saveTodos();
                }
            });
            renderTodos();

            // Clock Widget
            function updateClockWidget() {
                const now = new Date();
                document.getElementById('widget-clock-value').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('widget-clock-date').textContent = now.toLocaleDateString();
            }
            updateClockWidget();
            setInterval(updateClockWidget, 1000);

            // Calendar widget: show today's date
            function updateCalendarWidget() {
                const dateEl = document.getElementById('calendar-date');
                const now = new Date();
                const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
                dateEl.textContent = now.toLocaleDateString(undefined, options);
            }
            updateCalendarWidget();
            setInterval(updateCalendarWidget, 60000);

            // Weather widget: fetch weather for a default city (demo: New York)
            function updateWeatherWidget() {
                const weatherEl = document.getElementById('weather-value');
                // Use a public API or fallback to a placeholder
                fetch('https://wttr.in/New+York?format=%t+%C')
                    .then(res => res.text())
                    .then(txt => {
                        if (txt && txt.trim() && !txt.toLowerCase().includes('unknown')) {
                            weatherEl.textContent = txt;
                        } else {
                            weatherEl.textContent = '22C Sunny';
                        }
                    })
                    .catch(() => { weatherEl.textContent = '22C Sunny'; });
            }
            updateWeatherWidget();
            // Optionally refresh every 30 minutes
            setInterval(updateWeatherWidget, 1800000);
        });

        // --- Windows 11 Action Center ---
        // Toggle Action Center panel
        const acBtn = document.getElementById('action-center-btn');
        const acPanel = document.getElementById('action-center');
        acBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            acPanel.classList.toggle('active');
        });
        // Hide Action Center when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#action-center') && !e.target.closest('#action-center-btn')) {
                acPanel.classList.remove('active');
            }
        });
        // Demo toggles
        document.getElementById('ac-wifi').addEventListener('click', function() {
            this.classList.toggle('active');
            showNotification(this.classList.contains('active') ? 'Wi-Fi enabled' : 'Wi-Fi disabled', '');
        });
        document.getElementById('ac-bluetooth').addEventListener('click', function() {
            this.classList.toggle('active');
            showNotification(this.classList.contains('active') ? 'Bluetooth enabled' : 'Bluetooth disabled', '');
        });
        document.getElementById('ac-night').addEventListener('click', function() {
            this.classList.toggle('active');
            showNotification(this.classList.contains('active') ? 'Night Light on' : 'Night Light off', '');
        });
        // Dark mode toggle
        document.getElementById('ac-dark').addEventListener('click', function() {
            this.classList.toggle('active');
            document.body.classList.toggle('dark-mode');
            showNotification(document.body.classList.contains('dark-mode') ? 'Dark mode enabled' : 'Dark mode disabled', '');
        });
        // Airplane mode disables Wi-Fi and Bluetooth
        document.getElementById('ac-airplane').addEventListener('click', function() {
            this.classList.toggle('active');
            const wifi = document.getElementById('ac-wifi');
            const bt = document.getElementById('ac-bluetooth');
            if (this.classList.contains('active')) {
                wifi.classList.add('disabled');
                bt.classList.add('disabled');
                showNotification('Airplane mode enabled', '');
            } else {
                wifi.classList.remove('disabled');
                bt.classList.remove('disabled');
                showNotification('Airplane mode disabled', '');
            }
        });
        // Do Not Disturb hides notifications
        document.getElementById('ac-dnd').addEventListener('click', function() {
            this.classList.toggle('active');
            const notif = document.getElementById('ac-notifications');
            if (this.classList.contains('active')) {
                notif.style.display = 'none';
                showNotification('Do Not Disturb enabled', '');
            } else {
                notif.style.display = '';
                showNotification('Do Not Disturb disabled', '');
            }
        });
        // Demo sliders
        document.getElementById('ac-volume').addEventListener('input', function() {
            showNotification('Volume: ' + this.value + '%', '', 1200);
        });
        document.getElementById('ac-brightness').addEventListener('input', function() {
            // Set brightness using a CSS filter on the desktop
            document.getElementById('desktop').style.filter = `brightness(${this.value/100})`;
            showNotification('Brightness: ' + this.value + '%', '', 1200);
        });
        // Demo notification (for demonstration, show a notification after 2s)
        setTimeout(() => {
            showNotification('<b>Welcome!</b> This is your Action Center.', '');
        }, 2000);

        // --- File Explorer Context Menu Logic ---
        let feContextMenuTarget = null;
        let feContextMenuType = null;
        let feClipboard = null; // { type: 'copy'|'cut', path, item }
        let feContextMenuPath = null;

        function showFEContextMenu(e, name, type) {
            const menu = document.getElementById('fe-context-menu');
            feContextMenuTarget = name;
            feContextMenuType = type;
            feContextMenuPath = fileExplorerState.currentPath;
            // Enable/disable Paste
            const pasteLi = document.getElementById('fe-cm-paste');
            if (feClipboard) {
                pasteLi.classList.remove('disabled');
            } else {
                pasteLi.classList.add('disabled');
            }
            // Position menu
            menu.style.display = 'block';
            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            let x = e.clientX, y = e.clientY;
            if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 5;
            if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight - 5;
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        // Hide context menu on click elsewhere
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('fe-context-menu');
            if (menu.style.display === 'block' && !e.target.closest('.fe-context-menu')) {
                menu.style.display = 'none';
            }
        });
        // Hide on scroll or resize
        window.addEventListener('scroll', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
        });
        window.addEventListener('resize', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
        });
        // Context menu actions (with logic)
        document.getElementById('fe-cm-open').addEventListener('click', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
            const node = getNodeFromPath(feContextMenuPath);
            if (!node || !node.children) return;
            const item = node.children[feContextMenuTarget];
            if (!item) return;
            if (item.type === 'folder') {
                renderFileExplorer((feContextMenuPath === '/' ? '' : feContextMenuPath) + '/' + feContextMenuTarget);
            } else {
                showNotification(`Content of ${feContextMenuTarget}`, item.content.replace(/</g, "&lt;").replace(/>/g, "&gt;"), 5000);
            }
        });
        document.getElementById('fe-cm-rename').addEventListener('click', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
            const node = getNodeFromPath(feContextMenuPath);
            if (!node || !node.children) return;
            const item = node.children[feContextMenuTarget];
            if (!item) return;
            const newName = prompt('Enter new name:', feContextMenuTarget);
            if (!newName || newName === feContextMenuTarget) return;
            if (node.children[newName]) {
                showNotification('Rename', 'A file or folder with that name already exists.', 2200);
                return;
            }
            node.children[newName] = item;
            delete node.children[feContextMenuTarget];
            saveVFS();
            renderFileExplorer(feContextMenuPath);
        });
        document.getElementById('fe-cm-delete').addEventListener('click', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
            if (!confirm(`Are you sure you want to delete '${feContextMenuTarget}'? This cannot be undone.`)) return;
            const node = getNodeFromPath(feContextMenuPath);
            if (!node || !node.children) return;
            delete node.children[feContextMenuTarget];
            saveVFS();
            renderFileExplorer(feContextMenuPath);
        });
        document.getElementById('fe-cm-copy').addEventListener('click', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
            const node = getNodeFromPath(feContextMenuPath);
            if (!node || !node.children) return;
            const item = node.children[feContextMenuTarget];
            if (!item) return;
            feClipboard = {
                type: 'copy',
                path: feContextMenuPath,
                name: feContextMenuTarget,
                item: JSON.parse(JSON.stringify(item)) // deep copy
            };
            showNotification('Copy', `Copied ${feContextMenuTarget}`, 1200);
        });
        document.getElementById('fe-cm-cut').addEventListener('click', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
            const node = getNodeFromPath(feContextMenuPath);
            if (!node || !node.children) return;
            const item = node.children[feContextMenuTarget];
            if (!item) return;
            feClipboard = {
                type: 'cut',
                path: feContextMenuPath,
                name: feContextMenuTarget,
                item: item
            };
            showNotification('Cut', `Cut ${feContextMenuTarget}`, 1200);
        });
        document.getElementById('fe-cm-paste').addEventListener('click', () => {
            if (document.getElementById('fe-cm-paste').classList.contains('disabled')) return;
            document.getElementById('fe-context-menu').style.display = 'none';
            const destNode = getNodeFromPath(feContextMenuPath);
            if (!destNode || !destNode.children || !feClipboard) return;
            let baseName = feClipboard.name;
            let newName = baseName;
            let i = 1;
            while (destNode.children[newName]) {
                newName = baseName + ' (' + i + ')';
                i++;
            }
            if (feClipboard.type === 'copy') {
                destNode.children[newName] = JSON.parse(JSON.stringify(feClipboard.item));
            } else if (feClipboard.type === 'cut') {
                // Remove from old location
                const srcNode = getNodeFromPath(feClipboard.path);
                if (srcNode && srcNode.children && srcNode.children[feClipboard.name]) {
                    destNode.children[newName] = srcNode.children[feClipboard.name];
                    delete srcNode.children[feClipboard.name];
                }
                feClipboard = null;
            }
            saveVFS();
            renderFileExplorer(feContextMenuPath);
        });
        document.getElementById('fe-cm-properties').addEventListener('click', () => {
            document.getElementById('fe-context-menu').style.display = 'none';
            const node = getNodeFromPath(feContextMenuPath);
            if (!node || !node.children) return;
            const item = node.children[feContextMenuTarget];
            if (!item) return;
            let info = `<b>Name:</b> ${feContextMenuTarget}<br>`;
            info += `<b>Type:</b> ${item.type}<br>`;
            if (item.type === 'file') {
                info += `<b>Size:</b> ${item.content.length} bytes`;
            } else if (item.type === 'folder') {
                info += `<b>Items:</b> ${Object.keys(item.children).length}`;
            }
            showNotification('Properties', info, 3500);
        });

        // --- Widgets Panel Hide/Show Logic ---
        const widgetsPanel = document.getElementById('widgets-panel');
        const widgetsHideBtn = document.getElementById('widgets-hide-btn');
        const widgetsShowBtn = document.getElementById('widgets-show-btn');
        function setWidgetsHidden(hidden) {
            if (hidden) {
                widgetsPanel.classList.add('hide');
                widgetsShowBtn.style.display = 'flex';
                localStorage.setItem('webos-widgets-hidden', '1');
            } else {
                widgetsPanel.classList.remove('hide');
                widgetsShowBtn.style.display = 'none';
                localStorage.setItem('webos-widgets-hidden', '0');
            }
        }
        widgetsHideBtn.addEventListener('click', () => setWidgetsHidden(true));
        widgetsShowBtn.addEventListener('click', () => setWidgetsHidden(false));
        // Restore hidden state
        if (localStorage.getItem('webos-widgets-hidden') === '1') {
            setWidgetsHidden(true);
        }

        // --- Paint App Functionality ---
        function setupPaintApp() {
            const paintWindow = document.getElementById('paint-window');
            const canvas = document.getElementById('paint-canvas');
            const wrap = document.getElementById('paint-canvas-wrap');
            if (!canvas || !wrap || !paintWindow) return;
            // Prevent multiple setups
            if (canvas._paintSetup) return;
            canvas._paintSetup = true;
            // Responsive canvas size
            let resizeInterval = null;
            if (canvas._resizeInterval) clearInterval(canvas._resizeInterval);
            function resizeCanvas() {
                if (paintWindow.style.display === 'none') return;
                const parent = wrap;
                const w = Math.max(180, parent.clientWidth);
                const h = Math.max(100, parent.clientHeight);
                // Save current image
                const temp = document.createElement('canvas');
                temp.width = canvas.width;
                temp.height = canvas.height;
                temp.getContext('2d').drawImage(canvas, 0, 0);
                canvas.width = w;
                canvas.height = h;
                // Restore image
                canvas.getContext('2d').drawImage(temp, 0, 0);
            }
            // Initial size
            setTimeout(resizeCanvas, 50);
            // Resize on window resize or Paint window resize
            let lastW = 0, lastH = 0;
            function checkResize() {
                if (paintWindow.style.display === 'none') return;
                const w = wrap.clientWidth, h = wrap.clientHeight;
                if (w !== lastW || h !== lastH) {
                    lastW = w; lastH = h;
                    resizeCanvas();
                }
            }
            canvas._resizeInterval = setInterval(checkResize, 200);
            const ctx = canvas.getContext('2d');
            let painting = false;
            let lastX = 0, lastY = 0;
            let color = document.getElementById('paint-color').value;
            let size = document.getElementById('paint-size').value;
            let justLeft = false;
            const paintCursor = document.getElementById('paint-cursor');

            // Custom cursor update
            function updateCursor(x, y) {
                paintCursor.style.display = 'block';
                paintCursor.style.width = size + 'px';
                paintCursor.style.height = size + 'px';
                paintCursor.style.background = color + '22';
                paintCursor.style.borderColor = color + '44';
                paintCursor.style.left = (x - size/2) + 'px';
                paintCursor.style.top = (y - size/2) + 'px';
            }
            function hideCursor() {
                paintCursor.style.display = 'none';
            }

            function getXY(e) {
                const rect = canvas.getBoundingClientRect();
                if (e.touches) e = e.touches[0];
                // Clamp to canvas bounds
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                x = Math.max(0, Math.min(x, canvas.width));
                y = Math.max(0, Math.min(y, canvas.height));
                return [x, y];
            }

            function startPaint(e) {
                painting = true;
                justLeft = false;
                [lastX, lastY] = getXY(e);
            }
            function endPaint() { painting = false; ctx.beginPath(); }
            function draw(e) {
                const [x, y] = getXY(e);
                updateCursor(x, y);
                if (!painting) return;
                // Interpolate for smooth lines
                const dx = x - lastX, dy = y - lastY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const steps = Math.max(1, Math.floor(dist / (size/2)));
                ctx.strokeStyle = color;
                ctx.lineWidth = size;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                for (let i = 1; i <= steps; i++) {
                    const ix = lastX + (dx * i / steps);
                    const iy = lastY + (dy * i / steps);
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(ix, iy);
                    ctx.stroke();
                    [lastX, lastY] = [ix, iy];
                }
            }

            // Mouse events
            canvas.addEventListener('mousedown', startPaint);
            canvas.addEventListener('mouseup', endPaint);
            canvas.addEventListener('mouseleave', (e) => { painting = false; justLeft = true; hideCursor(); });
            canvas.addEventListener('mouseenter', (e) => {
                if (justLeft) painting = false;
                const [x, y] = getXY(e);
                updateCursor(x, y);
            });
            canvas.addEventListener('mousemove', draw);

            // Touch events
            canvas.addEventListener('touchstart', function(e) { startPaint(e); });
            canvas.addEventListener('touchend', function(e) { endPaint(); hideCursor(); });
            canvas.addEventListener('touchcancel', function(e) { endPaint(); hideCursor(); });
            canvas.addEventListener('touchmove', function(e) { draw(e); e.preventDefault(); }, { passive: false });

            // Cursor follow
            canvas.addEventListener('mousemove', function(e) {
                const [x, y] = getXY(e);
                updateCursor(x, y);
            });
            canvas.addEventListener('mouseleave', hideCursor);
            canvas.addEventListener('mouseenter', function(e) {
                const [x, y] = getXY(e);
                updateCursor(x, y);
            });

            document.getElementById('paint-color').addEventListener('input', e => {
                color = e.target.value;
                paintCursor.style.background = color + '22';
                paintCursor.style.borderColor = color + '44';
            });
            document.getElementById('paint-size').addEventListener('input', e => {
                size = e.target.value;
                paintCursor.style.width = size + 'px';
                paintCursor.style.height = size + 'px';
            });
            document.getElementById('paint-clear').addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
            document.getElementById('paint-save').addEventListener('click', () => {
                const dataURL = canvas.toDataURL('image/png');
                // Save to VFS as Paint_xxx.png in ~/Documents
                const docsNode = getNodeFromPath('~/Documents');
                if (docsNode && docsNode.children) {
                    let i = 1, fname = `Paint_${i}.png`;
                    while (docsNode.children[fname]) { i++; fname = `Paint_${i}.png`; }
                    docsNode.children[fname] = { type: 'file', content: dataURL };
                    saveVFS();
                    showNotification('Saved', `Saved as ${fname} in Documents.`, 2000);
                } else {
                    showNotification('Error', 'Could not save image.', 2000);
                }
            });
        }

        // --- Gallery App Functionality ---
        function setupGalleryApp() {
            const galleryGrid = document.getElementById('gallery-grid');
            const galleryWindow = document.getElementById('gallery-window');
            const preview = document.getElementById('gallery-preview');
            const previewImg = document.getElementById('gallery-preview-img');
            const prevBtn = document.getElementById('gallery-prev-btn');
            const nextBtn = document.getElementById('gallery-next-btn');
            const closeBtn = document.getElementById('gallery-close-btn');
            let images = [];
            let currentIdx = 0;

            function loadImages() {
                images = [];
                const docsNode = getNodeFromPath('~/Documents');
                if (docsNode && docsNode.children) {
                    for (const [name, file] of Object.entries(docsNode.children)) {
                        if (file.type === 'file' && (name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg'))) {
                            images.push({ name, src: file.content });
                        }
                    }
                }
            }

            function renderGallery() {
                loadImages();
                galleryGrid.innerHTML = '';
                if (images.length === 0) {
                    galleryGrid.innerHTML = '<div class="gallery-empty">No images found in Documents.</div>';
                    return;
                }
                images.forEach((img, idx) => {
                    const thumb = document.createElement('img');
                    thumb.className = 'gallery-thumb';
                    thumb.src = img.src;
                    thumb.alt = img.name;
                    thumb.title = img.name;
                    thumb.addEventListener('click', () => openPreview(idx));
                    galleryGrid.appendChild(thumb);
                });
            }

            function openPreview(idx) {
                if (images.length === 0) return;
                currentIdx = idx;
                previewImg.src = images[currentIdx].src;
                previewImg.alt = images[currentIdx].name;
                preview.style.display = 'flex';
            }
            function closePreview() {
                preview.style.display = 'none';
                previewImg.src = '';
            }
            function showPrev() {
                if (images.length === 0) return;
                currentIdx = (currentIdx - 1 + images.length) % images.length;
                openPreview(currentIdx);
            }
            function showNext() {
                if (images.length === 0) return;
                currentIdx = (currentIdx + 1) % images.length;
                openPreview(currentIdx);
            }
            prevBtn.addEventListener('click', showPrev);
            nextBtn.addEventListener('click', showNext);
            closeBtn.addEventListener('click', closePreview);
            preview.addEventListener('click', (e) => { if (e.target === preview) closePreview(); });
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (preview.style.display === 'flex') {
                    if (e.key === 'ArrowLeft') showPrev();
                    if (e.key === 'ArrowRight') showNext();
                    if (e.key === 'Escape') closePreview();
                }
            });

            // Render when Gallery window is opened
            if (galleryWindow) {
                const observer = new MutationObserver(() => {
                    if (galleryWindow.style.display === 'block') renderGallery();
                });
                observer.observe(galleryWindow, { attributes: true, attributeFilter: ['style'] });
            }
        }

        // --- Task Manager App Functionality ---
        function setupTaskmanApp() {
            const taskmanList = document.getElementById('taskman-list');
            const appMeta = [
                { app: 'notes', icon: '', title: 'Notes' },
                { app: 'music', icon: '', title: 'Music Player' },
                { app: 'calendar', icon: '', title: 'Calendar' },
                { app: 'terminal', icon: '', title: 'Terminal' },
                { app: 'settings', icon: '', title: 'Settings' },
                { app: 'calculator', icon: '', title: 'Calculator' },
                { app: 'files', icon: '', title: 'File Explorer' },
                { app: 'browser', icon: '', title: 'Browser' },
                { app: 'paint', icon: '', title: 'Paint' },
                { app: 'gallery', icon: '', title: 'Gallery' },
                { app: 'taskman', icon: '', title: 'Task Manager' },
                { app: 'shoppy', icon: '', title: 'shoppy.com' }
            ];
            function renderTaskList() {
                taskmanList.innerHTML = '';
                appMeta.forEach(meta => {
                    const win = document.getElementById(meta.app + '-window');
                    if (!win) return;
                    if (win.style.display === 'none') return; // Only show open windows
                    const item = document.createElement('div');
                    item.className = 'taskman-item';
                    item.innerHTML = `
                        <span class="taskman-icon">${meta.icon}</span>
                        <span class="taskman-title">${meta.title}</span>
                        <span class="taskman-state">${win.style.display === 'block' ? 'Open' : 'Minimized'}</span>
                        <button class="taskman-btn" data-action="switch">Switch</button>
                        <button class="taskman-btn" data-action="close">Close</button>
                    `;
                    item.querySelector('[data-action="switch"]').addEventListener('click', () => {
                        openWindow(meta.app);
                    });
                    item.querySelector('[data-action="close"]').addEventListener('click', () => {
                        win.style.display = 'none';
                        renderTaskList();
                    });
                    taskmanList.appendChild(item);
                });
                if (!taskmanList.innerHTML) {
                    taskmanList.innerHTML = '<div class="gallery-empty">No apps open.</div>';
                }
            }
            // Update in real time
            setInterval(renderTaskList, 500);
        }

        // --- Sticky Notes App Functionality ---
        function setupStickyNotesApp() {
            const notesKey = 'webos-stickynotes';
            let notes = JSON.parse(localStorage.getItem(notesKey) || '[]');
            const list = document.getElementById('stickynotes-list');
            const titleInput = document.getElementById('stickynote-title');
            const contentInput = document.getElementById('stickynote-content');
            const addBtn = document.getElementById('stickynote-add');
            function renderNotes() {
                list.innerHTML = '';
                notes.forEach((note, idx) => {
                    const item = document.createElement('div');
                    item.className = 'stickynote-item';
                    item.innerHTML = `<b>${note.title}</b><br>${note.content}<button class='stickynote-delete' title='Delete'>&times;</button>`;
                    item.querySelector('.stickynote-delete').addEventListener('click', () => {
                        notes.splice(idx, 1);
                        saveNotes();
                    });
                    list.appendChild(item);
                });
                if (!notes.length) list.innerHTML = '<div class="gallery-empty">No sticky notes.</div>';
            }
            function saveNotes() {
                localStorage.setItem(notesKey, JSON.stringify(notes));
                renderNotes();
            }
            addBtn.addEventListener('click', () => {
                const title = titleInput.value.trim() || 'Note';
                const content = contentInput.value.trim();
                if (!content) return;
                notes.push({ title, content });
                titleInput.value = '';
                contentInput.value = '';
                saveNotes();
            });
            renderNotes();
        }

        // --- Alarm/Timer App Functionality ---
        function setupAlarmApp() {
            const alarmKey = 'webos-alarms';
            let alarms = JSON.parse(localStorage.getItem(alarmKey) || '[]');
            const list = document.getElementById('alarm-list');
            const timeInput = document.getElementById('alarm-time');
            const timerInput = document.getElementById('timer-mins');
            const addBtn = document.getElementById('alarm-add');
            function renderAlarms() {
                list.innerHTML = '';
                alarms.forEach((alarm, idx) => {
                    const item = document.createElement('div');
                    item.className = 'alarm-item';
                    let label = '';
                    if (alarm.type === 'alarm') label = ' ' + alarm.time;
                    else label = ' ' + alarm.mins + ' min';
                    item.innerHTML = `${label}<button class='alarm-btn' title='Delete'>&times;</button>`;
                    item.querySelector('.alarm-btn').addEventListener('click', () => {
                        alarms.splice(idx, 1);
                        saveAlarms();
                    });
                    list.appendChild(item);
                });
                if (!alarms.length) list.innerHTML = '<div class="gallery-empty">No alarms/timers.</div>';
            }
            function saveAlarms() {
                localStorage.setItem(alarmKey, JSON.stringify(alarms));
                renderAlarms();
            }
            addBtn.addEventListener('click', () => {
                if (timeInput.value) {
                    alarms.push({ type: 'alarm', time: timeInput.value });
                    timeInput.value = '';
                } else if (timerInput.value && parseInt(timerInput.value) > 0) {
                    alarms.push({ type: 'timer', mins: parseInt(timerInput.value), set: Date.now() });
                    timerInput.value = '';
                } else {
                    return;
                }
                saveAlarms();
            });
            // Alarm/timer check
            setInterval(() => {
                const now = new Date();
                let changed = false;
                alarms.forEach((alarm, idx) => {
                    if (alarm.type === 'alarm') {
                        const [h, m] = alarm.time.split(':');
                        if (now.getHours() === parseInt(h) && now.getMinutes() === parseInt(m) && now.getSeconds() === 0) {
                            showNotification('Alarm', ` ${alarm.time}`, 3000);
                            alarms.splice(idx, 1); changed = true;
                        }
                    } else if (alarm.type === 'timer') {
                        const elapsed = Math.floor((Date.now() - alarm.set) / 60000);
                        if (elapsed >= alarm.mins) {
                            showNotification('Timer', ` ${alarm.mins} min done!`, 3000);
                            alarms.splice(idx, 1); changed = true;
                        }
                    }
                });
                if (changed) saveAlarms();
            }, 1000);
            renderAlarms();
        }

        // --- Minesweeper App Functionality ---
        function setupMinesweeperApp() {
            const boardEl = document.getElementById('minesweeper-board');
            const statusEl = document.getElementById('minesweeper-status');
            const sizeInput = document.getElementById('minesweeper-size');
            const minesInput = document.getElementById('minesweeper-mines');
            const restartBtn = document.getElementById('minesweeper-restart');
            let board = [], revealed = [], flagged = [], size = 8, mines = 10, started = false, gameover = false, timer = 0, timerInt = null;
            function startGame() {
                size = parseInt(sizeInput.value) || 8;
                mines = Math.min(parseInt(minesInput.value) || 10, size*size-1);
                board = Array(size).fill().map(()=>Array(size).fill(0));
                revealed = Array(size).fill().map(()=>Array(size).fill(false));
                flagged = Array(size).fill().map(()=>Array(size).fill(false));
                // Place mines
                let placed = 0;
                while (placed < mines) {
                    let r = Math.floor(Math.random()*size), c = Math.floor(Math.random()*size);
                    if (board[r][c] !== 'M') { board[r][c] = 'M'; placed++; }
                }
                // Fill numbers
                for (let r=0;r<size;r++) for (let c=0;c<size;c++) if (board[r][c]!=='M') {
                    let n=0; for (let dr=-1;dr<=1;dr++) for (let dc=-1;dc<=1;dc++) {
                        if (board[r+dr] && board[r+dr][c+dc]==='M') n++;
                    }
                    board[r][c]=n;
                }
                started = false; gameover = false; timer = 0;
                if (timerInt) clearInterval(timerInt);
                renderBoard();
                statusEl.textContent = 'Click a cell to start!';
            }
            function renderBoard() {
                boardEl.innerHTML = '';
                boardEl.style.gridTemplateColumns = `repeat(${size}, 28px)`;
                for (let r=0;r<size;r++) for (let c=0;c<size;c++) {
                    const cell = document.createElement('div');
                    cell.className = 'minesweeper-cell';
                    if (revealed[r][c]) {
                        cell.classList.add('revealed');
                        if (board[r][c]==='M') cell.classList.add('mine'), cell.textContent='';
                        else if (board[r][c]>0) cell.textContent=board[r][c];
                    } else if (flagged[r][c]) {
                        cell.classList.add('flag');
                        cell.textContent = '';
                    }
                    cell.addEventListener('click', e => {
                        if (gameover) return;
                        if (!started) { started = true; timer = 0; timerInt = setInterval(()=>{timer++; statusEl.textContent = `Time: ${timer}s`;},1000); }
                        if (flagged[r][c]) return;
                        if (board[r][c]==='M') {
                            revealed[r][c]=true; gameover=true; clearInterval(timerInt);
                            revealAll();
                            statusEl.textContent = 'Game Over!';
                        } else {
                            revealCell(r,c);
                            if (checkWin()) { gameover=true; clearInterval(timerInt); statusEl.textContent = `You Win! Time: ${timer}s`; }
                        }
                        renderBoard();
                    });
                    cell.addEventListener('contextmenu', e => {
                        e.preventDefault();
                        if (gameover || revealed[r][c]) return;
                        flagged[r][c]=!flagged[r][c];
                        renderBoard();
                    });
                    boardEl.appendChild(cell);
                }
            }
            function revealCell(r,c) {
                if (r<0||c<0||r>=size||c>=size||revealed[r][c]||flagged[r][c]) return;
                revealed[r][c]=true;
                if (board[r][c]===0) for (let dr=-1;dr<=1;dr++) for (let dc=-1;dc<=1;dc++) if (dr||dc) revealCell(r+dr,c+dc);
            }
            function revealAll() { for (let r=0;r<size;r++) for (let c=0;c<size;c++) revealed[r][c]=true; }
            function checkWin() {
                for (let r=0;r<size;r++) for (let c=0;c<size;c++) if (board[r][c]!=='M'&&!revealed[r][c]) return false;
                return true;
            }
            restartBtn.addEventListener('click', startGame);
            sizeInput.addEventListener('change', startGame);
            minesInput.addEventListener('change', startGame);
            startGame();
        }

        // --- Scientific Calculator App Functionality ---
        function setupSciCalcApp() {
            const display = document.getElementById('scicalc-display');
            const buttons = document.getElementById('scicalc-buttons');
            const historyEl = document.getElementById('scicalc-history');
            let expr = '';
            let history = [];
            const btns = [
                '7','8','9','/','sin',
                '4','5','6','*','cos',
                '1','2','3','-','tan',
                '0','.','=','+','log',
                '(',')','^','','exp',
                'C','CE','','e','Ans'
            ];
            btns.forEach(val => {
                const btn = document.createElement('button');
                btn.className = 'scicalc-btn' + (['/','*','-','+','=','sin','cos','tan','log','^','','exp','C','CE','','e','Ans'].includes(val)?' op':'');
                btn.textContent = val;
                btn.addEventListener('click', () => handleInput(val));
                buttons.appendChild(btn);
            });
            function handleInput(val) {
                if (val === 'C') { expr = ''; display.textContent = '0'; return; }
                if (val === 'CE') { expr = expr.slice(0,-1); display.textContent = expr||'0'; return; }
                if (val === '=') {
                    try {
                        let res = evalSci(expr);
                        history.push(expr+' = '+res);
                        if (history.length>3) history.shift();
                        historyEl.innerHTML = history.map(h=>h).join('<br>');
                        display.textContent = res;
                        expr = ''+res;
                    } catch { display.textContent = 'Error'; expr = ''; }
                    return;
                }
                if (val === '') val = 'Math.PI';
                if (val === 'e') val = 'Math.E';
                if (val === 'Ans') val = display.textContent;
                if (val === 'sin') val = 'Math.sin('; if (val === 'cos') val = 'Math.cos('; if (val === 'tan') val = 'Math.tan('; if (val === 'log') val = 'Math.log10('; if (val === 'exp') val = 'Math.exp('; if (val === '') val = 'Math.sqrt('; if (val === '^') val = '**';
                expr += val;
                display.textContent = expr;
            }
            function evalSci(s) {
                return Function('return '+s.replace(/Math\.log10/g,'(x=>Math.log(x)/Math.LN10)'))();
            }
        }

        // --- Tic-Tac-Toe App Functionality ---
        function setupTicTacToeApp() {
            const boardEl = document.getElementById('ttt-board');
            const statusEl = document.getElementById('ttt-status');
            const restartBtn = document.getElementById('ttt-restart');
            let board = Array(3).fill().map(()=>Array(3).fill(''));
            let turn = 'X', gameover = false;
            function renderBoard() {
                boardEl.innerHTML = '';
                for (let r=0;r<3;r++) for (let c=0;c<3;c++) {
                    const cell = document.createElement('div');
                    cell.className = 'ttt-cell';
                    cell.textContent = board[r][c];
                    cell.addEventListener('click', () => {
                        if (board[r][c]||gameover) return;
                        board[r][c]=turn;
                        if (checkWin(turn)) { statusEl.textContent = `${turn} wins!`; gameover=true; return; }
                        if (board.flat().every(x=>x)) { statusEl.textContent = 'Draw!'; gameover=true; return; }
                        turn = turn==='X'?'O':'X';
                        statusEl.textContent = `${turn}'s turn`;
                        renderBoard();
                    });
                    boardEl.appendChild(cell);
                }
            }
            function checkWin(t) {
                for (let i=0;i<3;i++) if (board[i][0]===t&&board[i][1]===t&&board[i][2]===t) return true;
                for (let i=0;i<3;i++) if (board[0][i]===t&&board[1][i]===t&&board[2][i]===t) return true;
                if (board[0][0]===t&&board[1][1]===t&&board[2][2]===t) return true;
                if (board[0][2]===t&&board[1][1]===t&&board[2][0]===t) return true;
                return false;
            }
            restartBtn.addEventListener('click', () => {
                board = Array(3).fill().map(()=>Array(3).fill(''));
                turn = 'X';
                gameover = false;
                statusEl.textContent = `${turn}'s turn`;
                renderBoard();
            });
            statusEl.textContent = `${turn}'s turn`;
            renderBoard();
        }

        const protradeLaunchBtn = document.getElementById('protrade-launch-btn');
        const protradeIframe = document.getElementById('protrade-iframe');
        if (protradeLaunchBtn && protradeIframe) {
            protradeLaunchBtn.addEventListener('click', () => {
                protradeIframe.src = 'https://sachin844123.github.io/ProTrading/';
                protradeIframe.style.display = 'block';
                protradeLaunchBtn.style.display = 'none';
            });
        }

        // Reset iframe when window is closed
        const protradeWindow = document.getElementById('protrade-window');
        if (protradeWindow && protradeIframe && protradeLaunchBtn) {
            protradeWindow.querySelector('.window-control.close').addEventListener('click', () => {
                protradeIframe.src = 'https://sachin844123.github.io/ProTrading/';
            });
        }

        // --- Power On Boot Sequence Logic ---
        let currentPhase = 0;
        const phases = ['power', 'bios', 'boot', 'welcome', 'lock', 'desktop'];

        // Power button click handler
        document.getElementById('powerButton').addEventListener('click', function() {
            // Request fullscreen on power button press
            const docElm = document.documentElement;
            if (docElm.requestFullscreen) {
                docElm.requestFullscreen();
            } else if (docElm.mozRequestFullScreen) { /* Firefox */
                docElm.mozRequestFullScreen();
            } else if (docElm.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                docElm.webkitRequestFullscreen();
            } else if (docElm.msRequestFullscreen) { /* IE/Edge */
                docElm.msRequestFullscreen();
            }
            const button = this;
            button.classList.add('active');
            // Play power-on sound
            const powerOnAudio = document.getElementById('powerOnSound');
            if (powerOnAudio) {
                powerOnAudio.currentTime = 0;
                powerOnAudio.play();
            }
            // After sound, speak welcome message
            setTimeout(() => {
                if ('speechSynthesis' in window) {
                    const utter = new SpeechSynthesisUtterance('Welcome back, chief');
                    utter.lang = 'en-US';
                    window.speechSynthesis.speak(utter);
                }
                startBootSequence();
            }, 1800); // Wait for sound to finish (adjust if needed)
        });

        function startBootSequence() {
            // Hide power screen, show BIOS
            document.getElementById('poweron-overlay').style.display = 'none';
            document.getElementById('biosScreen').style.display = 'block';
            // Start BIOS loading animations
            setTimeout(() => animateProgress('memoryProgress', 'memoryPercent', 2000), 500);
            setTimeout(() => animateProgress('skillsProgress', 'skillsPercent', 1500), 1000);
            setTimeout(() => animateProgress('portfolioProgress', 'portfolioPercent', 1000), 2000);
            // Transition to boot sequence
            setTimeout(() => {
                document.getElementById('biosScreen').style.display = 'none';
                document.getElementById('bootSequence').style.display = 'block';
                animateBootLines();
            }, 4000);
        }

        function animateProgress(barId, percentId, duration) {
            const bar = document.getElementById(barId);
            const percent = document.getElementById(percentId);
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                bar.style.width = progress + '%';
                percent.textContent = Math.floor(progress) + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, duration / 20);
        }

        function animateBootLines() {
            const lines = document.querySelectorAll('.boot-line');
            lines.forEach((line, index) => {
                setTimeout(() => {
                    line.style.opacity = '1';
                    line.style.animationDelay = '0s';
                    // If it's the last line, show welcome screen
                    if (index === lines.length - 1) {
                        setTimeout(() => {
                            document.getElementById('bootSequence').style.display = 'none';
                            document.getElementById('welcomeScreen').style.display = 'flex';
                        }, 2000);
                    }
                }, index * 200);
            });
        }

        function enterPortfolio() {
            document.getElementById('welcomeScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcomeScreen').style.display = 'none';
                // Show the lock screen instead of desktop
                document.getElementById('lockscreen-overlay').style.display = 'flex';
                document.getElementById('lockscreen-overlay').style.opacity = 1;
                document.getElementById('lockscreen-overlay').style.transform = '';
            }, 1000);
        }

        // Lock screen logic
        function updateLockscreenTime() {
            const now = new Date();
            document.getElementById('lockscreen-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lockscreen-date').textContent = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
        }
        setInterval(updateLockscreenTime, 1000);
        updateLockscreenTime();

        // Slide up to unlock logic (touch)
        let lockStartY = null;
        const lockscreen = document.getElementById('lockscreen-overlay');
        lockscreen.addEventListener('touchstart', e => {
            lockStartY = e.touches[0].clientY;
        });
        lockscreen.addEventListener('touchmove', e => {
            if (lockStartY !== null) {
                let deltaY = e.touches[0].clientY - lockStartY;
                if (deltaY < 0) { // Only allow upward movement
                    lockscreen.style.transform = `translateY(${deltaY}px)`;
                }
            }
        });
        lockscreen.addEventListener('touchend', e => {
            if (lockStartY !== null) {
                let deltaY = e.changedTouches[0].clientY - lockStartY;
                if (deltaY < -80) { // Threshold for unlock
                    unlockOS();
                } else {
                    lockscreen.style.transform = '';
                }
                lockStartY = null;
            }
        });
        // Mouse drag for desktop users
        let mouseStartY = null;
        lockscreen.addEventListener('mousedown', e => {
            mouseStartY = e.clientY;
        });
        window.addEventListener('mousemove', e => {
            if (mouseStartY !== null) {
                let deltaY = e.clientY - mouseStartY;
                if (deltaY < 0) {
                    lockscreen.style.transform = `translateY(${deltaY}px)`;
                }
            }
        });
        window.addEventListener('mouseup', e => {
            if (mouseStartY !== null) {
                let deltaY = e.clientY - mouseStartY;
                if (deltaY < -80) {
                    unlockOS();
                } else {
                    lockscreen.style.transform = '';
                }
                mouseStartY = null;
            }
        });
        // Also unlock on double-click or pressing Enter (for accessibility)
        lockscreen.addEventListener('dblclick', unlockOS);
        lockscreen.addEventListener('keydown', e => {
            if (e.key === 'Enter') unlockOS();
        });
        // Unlock function
        function unlockOS() {
            lockscreen.style.transform = 'translateY(-100vh)';
            lockscreen.style.opacity = 0;
            setTimeout(() => { 
                lockscreen.style.display = 'none';
                // Show the main desktop
                document.getElementById('desktop').style.display = '';
            }, 700);
        }
        // Focus lockscreen for keyboard events
        document.getElementById('lockscreen-overlay').tabIndex = 0;
        document.getElementById('lockscreen-overlay').focus();
        // Keyboard shortcut for Enter on welcome screen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('welcomeScreen').style.display === 'flex') {
                enterPortfolio();
            }
        });

        // Example: play notification sound (call playNotifSound() where needed)
        function playNotifSound() {
            const notif = document.getElementById('notifSound');
            if (notif) { notif.currentTime = 0; notif.play(); }
        }
        // Example: play window sound (call playWindowSound() where needed)
        function playWindowSound() {
            const win = document.getElementById('windowSound');
            if (win) { win.currentTime = 0; win.play(); }
        }

        // Add this near your main <script> in os.html
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'set-wallpaper' && event.data.url) {
                setWallpaper(`url('${event.data.url}')`);
            }
        });
    </script>
    <script src="jarvis-Ai-main/app.js"></script>
    <link rel="stylesheet" href="jarvis-Ai-main/style.css">
</body>
</html>